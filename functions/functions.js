"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SerializeGameData = exports.HttpResponse = exports.deleteGame = exports.modifyGame = exports.createGame = exports.listGames = exports.getGame = void 0;
const AWS = require('aws-sdk');
const docClient = new AWS.DynamoDB.DocumentClient();
const table = process.env.DYNAMO_DB_TABLE;
const modules_1 = require("./modules");
const allowedRequestParameters = JSON.parse(process.env.ALLOWED_REQUEST_PARAMETERS);
async function getGame(gameName) {
    let params = {
        TableName: table,
        Key: {
            gameName: gameName
        }
    };
    try {
        let response = await docClient.get(params).promise();
        if (response.Item) {
            let game = SerializeGameData(response.Item);
            return HttpResponse({ statusCode: 200, body: JSON.stringify(game) });
        }
        else {
            return HttpResponse({ statusCode: 404, body: "Unable to find game." });
        }
    }
    catch (err) {
        return HttpResponse({ statusCode: 400, body: "Unable to find game." });
    }
}
exports.getGame = getGame;
async function listGames() {
    let params = {
        TableName: table,
        Select: "ALL_ATTRIBUTES"
    };
    try {
        let response = await docClient.scan(params).promise();
        let gameList = [];
        if (response.Items) {
            response.Items.forEach((game) => {
                gameList.push(SerializeGameData(game));
            });
            return HttpResponse({ statusCode: 200, body: JSON.stringify(gameList) });
        }
        else {
            return HttpResponse({ statusCode: 404, body: 'Game list could not be found.' });
        }
    }
    catch (err) {
        return HttpResponse({ statusCode: 400, body: 'Game list could not be found.' });
    }
}
exports.listGames = listGames;
async function createGame(game) {
    let params = {
        TableName: table,
        Item: {
            gameName: game.gameName,
            genre: game.genre,
            yearReleased: game.yearReleased,
            developer: game.developer,
            console: game.console
        },
        ConditionExpression: 'attribute_not_exists(gameName)'
    };
    try {
        let response = await docClient.put(params).promise();
        if (Object.keys(response).length == 0) {
            return HttpResponse({ statusCode: 201, body: JSON.stringify(game) });
        }
        else {
            return HttpResponse({ statusCode: 403, body: 'Unable to create game.' });
        }
    }
    catch (err) {
        return HttpResponse({ statusCode: 400, body: 'Unable to create game.' });
    }
}
exports.createGame = createGame;
async function modifyGame(game) {
    let updateExpression = [];
    let expressionAttributeNames = {};
    let expressionAttributeValues = {};
    //Generate dynammic update expression based on allowed parameters
    for (let [key, value] of Object.entries(game)) {
        if (allowedRequestParameters.includes(key) && value != undefined) {
            updateExpression.push(`#${key} = :${key}`);
            expressionAttributeNames['#' + key] = key;
            expressionAttributeValues[':' + key] = `${value}`;
        }
    }
    let params = {
        TableName: table,
        Key: {
            gameName: game.gameName
        },
        UpdateExpression: `SET ${updateExpression.join(",")}`,
        ExpressionAttributeNames: expressionAttributeNames,
        ExpressionAttributeValues: expressionAttributeValues,
        ConditionExpression: 'attribute_exists(gameName)',
        ReturnValues: 'ALL_NEW'
    };
    try {
        let response = await docClient.update(params).promise();
        if (response.Attributes) {
            let modifiedGame = SerializeGameData(response.Attributes);
            return HttpResponse({ statusCode: 200, body: JSON.stringify(modifiedGame) });
        }
        else {
            return HttpResponse({ statusCode: 403, body: 'Unable to modify game.' });
        }
    }
    catch (err) {
        return HttpResponse({ statusCode: 400, body: 'Unable to modify game.' });
    }
}
exports.modifyGame = modifyGame;
async function deleteGame(gameName) {
    let params = {
        TableName: table,
        Key: {
            gameName: gameName
        },
        ReturnValues: 'ALL_OLD'
    };
    try {
        let response = await docClient.delete(params).promise();
        if (response.Attributes) {
            let deletedGame = SerializeGameData(response.Attributes);
            return HttpResponse({ statusCode: 200, body: JSON.stringify(deletedGame) });
        }
        else {
            return HttpResponse({ statusCode: 404, body: 'Unable to delete game.' });
        }
    }
    catch (err) {
        return HttpResponse({ statusCode: 400, body: 'Unable to delete game.' });
    }
}
exports.deleteGame = deleteGame;
function HttpResponse(data) {
    return {
        statusCode: data.statusCode,
        body: data.body,
        headers: {
            'Access-Control-Allow-Origin': '*'
        }
    };
}
exports.HttpResponse = HttpResponse;
function SerializeGameData(data) {
    return new modules_1.Game(data.gameName, data.yearReleased, data.genre, data.console, data.developer);
}
exports.SerializeGameData = SerializeGameData;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVuY3Rpb25zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZnVuY3Rpb25zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUMvQixNQUFNLFNBQVMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsY0FBYyxFQUFFLENBQUM7QUFDcEQsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUM7QUFDMUMsdUNBQTZEO0FBQzdELE1BQU0sd0JBQXdCLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLDBCQUEyQixDQUFDLENBQUM7QUFFOUUsS0FBSyxVQUFVLE9BQU8sQ0FBQyxRQUFnQjtJQUMxQyxJQUFJLE1BQU0sR0FBRztRQUNYLFNBQVMsRUFBRSxLQUFLO1FBQ2hCLEdBQUcsRUFBRTtZQUNILFFBQVEsRUFBRSxRQUFRO1NBQ25CO0tBQ0YsQ0FBQztJQUVGLElBQUk7UUFDRixJQUFJLFFBQVEsR0FBRyxNQUFNLFNBQVMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDckQsSUFBSSxRQUFRLENBQUMsSUFBSSxFQUFFO1lBQ2pCLElBQUksSUFBSSxHQUFHLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM1QyxPQUFPLFlBQVksQ0FBQyxFQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEVBQUMsQ0FBQyxDQUFDO1NBQ3BFO2FBQU07WUFDTCxPQUFPLFlBQVksQ0FBQyxFQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLHNCQUFzQixFQUFDLENBQUMsQ0FBQztTQUN0RTtLQUNGO0lBQUMsT0FBTyxHQUFHLEVBQUU7UUFDWixPQUFPLFlBQVksQ0FBQyxFQUFDLFVB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QUVELFNBQWdCLGlCQUFpQixDQUFDLElBQWlCO0lBQ2pELE9BQU8sSUFBSSxjQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDL0YsQ0FBQztBQUZBLDhDQUVBIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgQVdTID0gcmVxdWlyZSgnYXdzLXNkaycpO1xyXG5jb25zdCBkb2NDbGllbnQgPSBuZXcgQVdTLkR5bmFtb0RCLkRvY3VtZW50Q2xpZW50KCk7XHJcbmNvbnN0IHRhYmxlID0gcHJvY2Vzcy5lbnYuRFlOQU1PX0RCX1RBQkxFO1xyXG5pbXBvcnQgeyBHYW1lLCBJSHR0cFJlc3BvbnNlLCBJR2FtZU9iamVjdCB9IGZyb20gXCIuL21vZHVsZXNcIjtcclxuY29uc3QgYWxsb3dlZFJlcXVlc3RQYXJhbWV0ZXJzID0gSlNPTi5wYXJzZShwcm9jZXNzLmVudi5BTExPV0VEX1JFUVVFU1RfUEFSQU1FVEVSUyEpO1xyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEdhbWUoZ2FtZU5hbWU6IHN0cmluZykge1xyXG4gICAgbGV0IHBhcmFtcyA9IHtcclxuICAgICAgVGFibGVOYW1lOiB0YWJsZSxcclxuICAgICAgS2V5OiB7XHJcbiAgICAgICAgZ2FtZU5hbWU6IGdhbWVOYW1lXHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgXHJcbiAgICB0cnkge1xyXG4gICAgICBsZXQgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQuZ2V0KHBhcmFtcykucHJvbWlzZSgpO1xyXG4gICAgICBpZiAocmVzcG9uc2UuSXRlbSkge1xyXG4gICAgICAgIGxldCBnYW1lID0gU2VyaWFsaXplR2FtZURhdGEocmVzcG9uc2UuSXRlbSk7XHJcbiAgICAgICAgcmV0dXJuIEh0dHBSZXNwb25zZSh7c3RhdHVzQ29kZTogMjAwLCBib2R5OiBKU09OLnN0cmluZ2lmeShnYW1lKX0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiBIdHRwUmVzcG9uc2Uoe3N0YXR1c0NvZGU6IDQwNCwgYm9keTogXCJVbmFibGUgdG8gZmluZCBnYW1lLlwifSk7XHJcbiAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICByZXR1cm4gSHR0cFJlc3BvbnNlKHtzdGF0dXNDb2RlOiA0MDAsIGJvZHk6IFwiVW5hYmxlIHRvIGZpbmQgZ2FtZS5cIn0pO1xyXG4gICAgfVxyXG4gIH1cclxuICBcclxuICBleHBvcnQgYXN5bmMgZnVuY3Rpb24gbGlzdEdhbWVzKCkge1xyXG4gICAgbGV0IHBhcmFtcyA9IHtcclxuICAgICAgVGFibGVOYW1lOiB0YWJsZSxcclxuICAgICAgU2VsZWN0OiBcIkFMTF9BVFRSSUJVVEVTXCJcclxuICAgIH07XHJcbiAgICBcclxuICAgIHRyeSB7XHJcbiAgICAgIGxldCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5zY2FuKHBhcmFtcykucHJvbWlzZSgpO1xyXG4gICAgICBsZXQgZ2FtZUxpc3QgOiBHYW1lW10gPSBbXTtcclxuICAgICAgXHJcbiAgICAgIGlmIChyZXNwb25zZS5JdGVtcykge1xyXG4gICAgICAgIHJlc3BvbnNlLkl0ZW1zLmZvckVhY2goKGdhbWU6IElHYW1lT2JqZWN0KSA9PiB7XHJcbiAgICAgICAgICBnYW1lTGlzdC5wdXNoKFNlcmlhbGl6ZUdhbWVEYXRhKGdhbWUpKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gSHR0cFJlc3BvbnNlKHtzdGF0dXNDb2RlOiAyMDAsIGJvZHk6IEpTT04uc3RyaW5naWZ5KGdhbWVMaXN0KX0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiBIdHRwUmVzcG9uc2Uoe3N0YXR1c0NvZGU6IDQwNCwgYm9keTogJ0dhbWUgbGlzdCBjb3VsZCBub3QgYmUgZm91bmQuJ30pXHJcbiAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICByZXR1cm4gSHR0cFJlc3BvbnNlKHtzdGF0dXNDb2RlOiA0MDAsIGJvZHk6ICdHYW1lIGxpc3QgY291bGQgbm90IGJlIGZvdW5kLid9KVxyXG4gICAgfVxyXG4gIH1cclxuICBcclxuICBleHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlR2FtZShnYW1lOiBHYW1lKSB7XHJcbiAgICBsZXQgcGFyYW1zID0ge1xyXG4gICAgICBUYWJsZU5hbWU6IHRhYmxlLFxyXG4gICAgICBJdGVtOiB7XHJcbiAgICAgICAgZ2FtZU5hbWU6IGdhbWUuZ2FtZU5hbWUsXHJcbiAgICAgICAgZ2VucmU6IGdhbWUuZ2VucmUsXHJcbiAgICAgICAgeWVhclJlbGVhc2VkOiBnYW1lLnllYXJSZWxlYXNlZCxcclxuICAgICAgICBkZXZlbG9wZXI6IGdhbWUuZGV2ZWxvcGVyLFxyXG4gICAgICAgIGNvbnNvbGU6IGdhbWUuY29uc29sZVxyXG4gICAgICB9LFxyXG4gICAgICBDb25kaXRpb25FeHByZXNzaW9uOiAnYXR0cmlidXRlX25vdF9leGlzdHMoZ2FtZU5hbWUpJ1xyXG4gICAgfVxyXG4gIFxyXG4gICAgdHJ5IHtcclxuICAgICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnB1dChwYXJhbXMpLnByb21pc2UoKTtcclxuICAgICAgaWYgKE9iamVjdC5rZXlzKHJlc3BvbnNlKS5sZW5ndGggPT0gMCkge1xyXG4gICAgICAgIHJldHVybiBIdHRwUmVzcG9uc2Uoe3N0YXR1c0NvZGU6IDIwMSwgYm9keTogSlNPTi5zdHJpbmdpZnkoZ2FtZSl9KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gSHR0cFJlc3BvbnNlKHtzdGF0dXNDb2RlOiA0MDMsIGJvZHk6ICdVbmFibGUgdG8gY3JlYXRlIGdhbWUuJ30pO1xyXG4gICAgICB9XHJcbiAgICB9IGNhdGNoKGVycikge1xyXG4gICAgICByZXR1cm4gSHR0cFJlc3BvbnNlKHtzdGF0dXNDb2RlOiA0MDAsIGJvZHk6ICdVbmFibGUgdG8gY3JlYXRlIGdhbWUuJ30pO1xyXG4gICAgfVxyXG4gIH1cclxuICBcclxuICBleHBvcnQgYXN5bmMgZnVuY3Rpb24gbW9kaWZ5R2FtZShnYW1lOiBHYW1lKSB7XHJcbiAgICBsZXQgdXBkYXRlRXhwcmVzc2lvbjogU3RyaW5nW10gPSBbXTtcclxuICAgIGxldCBleHByZXNzaW9uQXR0cmlidXRlTmFtZXMgPSB7fSBhcyBhbnk7XHJcbiAgICBsZXQgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyA9IHt9IGFzIGFueTtcclxuICAgIFxyXG4gICAgLy9HZW5lcmF0ZSBkeW5hbW1pYyB1cGRhdGUgZXhwcmVzc2lvbiBiYXNlZCBvbiBhbGxvd2VkIHBhcmFtZXRlcnNcclxuICAgIGZvciAobGV0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhnYW1lKSkge1xyXG4gICAgICBpZiAoYWxsb3dlZFJlcXVlc3RQYXJhbWV0ZXJzLmluY2x1ZGVzKGtleSkgJiYgdmFsdWUgIT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgdXBkYXRlRXhwcmVzc2lvbi5wdXNoKGAjJHtrZXl9ID0gOiR7a2V5fWApO1xyXG4gICAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1snIycra2V5XSA9IGtleSA7XHJcbiAgICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOicra2V5XT1gJHt2YWx1ZX1gOyAgXHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIFxyXG4gICAgbGV0IHBhcmFtcyA9IHtcclxuICAgICAgVGFibGVOYW1lOiB0YWJsZSxcclxuICAgICAgS2V5OiB7XHJcbiAgICAgICAgZ2FtZU5hbWU6IGdhbWUuZ2FtZU5hbWVcclxuICAgICAgfSxcclxuICAgICAgVXBkYXRlRXhwcmVzc2lvbjogYFNFVCAke3VwZGF0ZUV4cHJlc3Npb24uam9pbihcIixcIil9YCxcclxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiBleHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXHJcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMsXHJcbiAgICAgIENvbmRpdGlvbkV4cHJlc3Npb246ICdhdHRyaWJ1dGVfZXhpc3RzKGdhbWVOYW1lKScsXHJcbiAgICAgIFJldHVyblZhbHVlczogJ0FMTF9ORVcnXHJcbiAgICB9O1xyXG4gIFxyXG4gICAgdHJ5IHtcclxuICAgICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnVwZGF0ZShwYXJhbXMpLnByb21pc2UoKTtcclxuICAgICAgaWYgKHJlc3BvbnNlLkF0dHJpYnV0ZXMpIHtcclxuICAgICAgICBsZXQgbW9kaWZpZWRHYW1lID0gU2VyaWFsaXplR2FtZURhdGEocmVzcG9uc2UuQXR0cmlidXRlcyk7XHJcbiAgICAgICAgcmV0dXJuIEh0dHBSZXNwb25zZSh7c3RhdHVzQ29kZTogMjAwLCBib2R5OiBKU09OLnN0cmluZ2lmeShtb2RpZmllZEdhbWUpfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIEh0dHBSZXNwb25zZSh7c3RhdHVzQ29kZTogNDAzLCBib2R5OiAnVW5hYmxlIHRvIG1vZGlmeSBnYW1lLid9KTtcclxuICAgICAgfVxyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgIHJldHVybiBIdHRwUmVzcG9uc2Uoe3N0YXR1c0NvZGU6IDQwMCwgYm9keTogJ1VuYWJsZSB0byBtb2RpZnkgZ2FtZS4nfSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIFxyXG4gIGV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZWxldGVHYW1lKGdhbWVOYW1lOiBzdHJpbmcpIHtcclxuICAgIGxldCBwYXJhbXMgPSB7XHJcbiAgICAgIFRhYmxlTmFtZTogdGFibGUsXHJcbiAgICAgIEtleToge1xyXG4gICAgICAgICAgZ2FtZU5hbWU6IGdhbWVOYW1lXHJcbiAgICAgIH0sXHJcbiAgICAgIFJldHVyblZhbHVlczogJ0FMTF9PTEQnXHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB0cnkge1xyXG4gICAgICBsZXQgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQuZGVsZXRlKHBhcmFtcykucHJvbWlzZSgpO1xyXG4gICAgICBpZiAocmVzcG9uc2UuQXR0cmlidXRlcykge1xyXG4gICAgICAgIGxldCBkZWxldGVkR2FtZSA9IFNlcmlhbGl6ZUdhbWVEYXRhKHJlc3BvbnNlLkF0dHJpYnV0ZXMpO1xyXG4gICAgICAgIHJldHVybiBIdHRwUmVzcG9uc2Uoe3N0YXR1c0NvZGU6IDIwMCwgYm9keTogSlNPTi5zdHJpbmdpZnkoZGVsZXRlZEdhbWUpfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIEh0dHBSZXNwb25zZSh7c3RhdHVzQ29kZTogNDA0LCBib2R5OiAnVW5hYmxlIHRvIGRlbGV0ZSBnYW1lLid9KTtcclxuICAgICAgfVxyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgIHJldHVybiBIdHRwUmVzcG9uc2Uoe3N0YXR1c0NvZGU6IDQwMCwgYm9keTogJ1VuYWJsZSB0byBkZWxldGUgZ2FtZS4nfSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIFxyXG4gIGV4cG9ydCBmdW5jdGlvbiBIdHRwUmVzcG9uc2UoZGF0YTogSUh0dHBSZXNwb25zZSkge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgc3RhdHVzQ29kZTogZGF0YS5zdGF0dXNDb2RlLFxyXG4gICAgICBib2R5OiBkYXRhLmJvZHksXHJcbiAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIGV4cG9ydCBmdW5jdGlvbiBTZXJpYWxpemVHYW1lRGF0YShkYXRhOiBJR2FtZU9iamVjdCkge1xyXG4gICAgcmV0dXJuIG5ldyBHYW1lKGRhdGEuZ2FtZU5hbWUsIGRhdGEueWVhclJlbGVhc2VkLCBkYXRhLmdlbnJlLCBkYXRhLmNvbnNvbGUsIGRhdGEuZGV2ZWxvcGVyKTtcclxuIH1cclxuICJdfQ==