"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.serializeDynamoResponse = exports.deleteGame = exports.modifyGame = exports.listGames = exports.getGame = void 0;
const AWS = require('aws-sdk');
const isTest = process.env.JEST_WORKER_ID;
const config = {
    convertEmptyValues: true,
    ...(isTest && {
        endpoint: 'localhost:8000',
        sslEnabled: false,
        region: 'local-env',
    }),
};
const docClient = new AWS.DynamoDB.DocumentClient(config);
const table = (isTest) ? process.env.DYNAMO_DB_TEST_TABLE : process.env.DYNAMO_DB_GAME_TABLE;
const game_1 = require("./game");
const gameErrorHandler_1 = require("./gameErrorHandler");
async function getGame(game) {
    let params = {
        TableName: table,
        Key: {
            userID: game.userID,
            gameName: game.gameName
        },
        KeyConditionExpression: `gameName = ${game.gameName} AND userID = ${game.userID}`
    };
    try {
        let response = await docClient.get(params).promise();
        let game = serializeDynamoResponse(response.Item);
        return game;
    }
    catch (err) {
        //Dynamo returns an empty object if the get can't find a record.
        //Not sure how to handle this since the documentClient doesn't throw an error
        if (err.message == "Cannot read property 'userID' of undefined") {
            throw new gameErrorHandler_1.GameError("Unable to find game.", 404);
        }
        throw new gameErrorHandler_1.GameError(err.message, err.statusCode);
    }
}
exports.getGame = getGame;
async function listGames(userID) {
    let params = {
        TableName: table,
        KeyConditionExpression: "#userID = :userID",
        ExpressionAttributeNames: {
            "#userID": "userID"
        },
        ExpressionAttributeValues: {
            ":userID": userID
        }
    };
    try {
        let response = await docClient.query(params).promise();
        let gameList = [];
        response.Items.forEach((game) => {
            let returnedGame = serializeDynamoResponse(game);
            gameList.push(returnedGame);
        });
        return gameList;
    }
    catch (err) {
        throw new gameErrorHandler_1.GameError(err.message, err.statusCode);
    }
}
exports.listGames = listGames;
async function modifyGame(game) {
    let updateExpression = [];
    let expressionAttributeNames = {};
    let expressionAttributeValues = {};
    //Generate dynammic update expression based on allowed parameters
    for (let [key, value] of Object.entries(game)) {
        if (key != 'userID' && key != 'gameName' && value != undefined) {
            updateExpression.push(`#${key} = :${key}`);
            expressionAttributeNames[`#${key}`] = key;
            expressionAttributeValues[`:${key}`] = value;
        }
    }
    let params = {
        TableName: table,
        Key: {
            userID: game.userID,
            gameName: game.gameName
        },
        KeyConditionExpression: `gameName = ${game.gameName} AND userID = ${game.userID}`,
        UpdateExpression: `SET ${updateExpression.join(",")}`,
        ExpressionAttributeNames: expressionAttributeNames,
        ExpressionAttributeValues: expressionAttributeValues,
        ConditionExpression: 'attribute_exists(gameName) and attribute_exists(userID)',
        ReturnValues: 'ALL_NEW'
    };
    try {
        let response = await docClient.update(params).promise();
        let modifiedGame = await getGame(game);
        return modifiedGame;
    }
    catch (err) {
        throw new gameErrorHandler_1.GameError(err.message, err.statusCode);
    }
}
exports.modifyGame = modifyGame;
async function deleteGame(game) {
    let params = {
        TableName: table,
        Key: {
            userID: game.userID,
            gameName: game.gameName
        },
        KeyConditionExpression: `gameName = ${game.gameName} AND userID = ${game.userID}`,
        ConditionExpression: 'attribute_exists(gameName) and attribute_exists(userID)',
        ReturnValues: 'ALL_OLD'
    };
    try {
        let response = await docClient.delete(params).promise();
        let game = serializeDynamoResponse(response.Attributes);
        return game;
    }
    catch (err) {
        throw new gameErrorHandler_1.GameError(err.message, err.statusCode);
    }
}
exports.deleteGame = deleteGame;
function serializeDynamoResponse(data) {
    let game = new game_1.Game(data.userID, data.gameName, data === null || data === void 0 ? void 0 : data.yearReleased, data === null || data === void 0 ? void 0 : data.genre, data === null || data === void 0 ? void 0 : data.console, data === null || data === void 0 ? void 0 : data.developer);
    return game;
}
exports.serializeDynamoResponse = serializeDynamoResponse;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2FtZU1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnYW1lTWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDL0IsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUM7QUFDMUMsTUFBTSxNQUFNLEdBQUc7SUFDYixrQkFBa0IsRUFBRSxJQUFJO0lBQ3hCLEdBQUcsQ0FBQyxNQUFNLElBQUk7UUFDWixRQUFRLEVBQUUsZ0JBQWdCO1FBQzFCLFVBQVUsRUFBRSxLQUFLO1FBQ2pCLE1BQU0sRUFBRSxXQUFXO0tBQ3BCLENBQUM7Q0FDSCxDQUFDO0FBQ0YsTUFBTSxTQUFTLEdBQUcsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMxRCxNQUFNLEtBQUssR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDO0FBQzdGLGlDQUE4QjtBQUM5Qix5REFBK0M7QUFFdkMsS0FBSyxVQUFVLE9BQU8sQ0FBQyxJQUFVO0lBQ3JDLElBQUksTUFBTSxHQUFHO1FBQ1gsU0FBUyxFQUFFLEtBQUs7UUFDaEIsR0FBRyxFQUFFO1lBQ0gsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNO1lBQ25CLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtTQUN4QjtRQUNELHNCQUFzQixFQUFFLGNBQWMsSUFBSSxDQUFDLFFBQVEsaUJBQWlCLElBQUksQ0FBQyxNQUFNLEVBQUU7S0FDbEYsQ0FBQTtJQUVELElBQUk7UUFDRixJQUFJLFFBQVEsR0FBRyxNQUFNLFNBQVMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDckQs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Q0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLGFBQUosSUFBSSx1QkFBSixJQUFJLENBQUUsWUFBWSxFQUFFLElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSxLQUFLLEVBQUUsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLE9BQU8sRUFBRSxJQUFJLGFBQUosSUFBSSx1QkFBSixJQUFJLENBQUUsU0FBUyxDQUFDLENBQUM7SUFDakgsT0FBTyxJQUFJLENBQUM7QUFDZCxDQUFDO0FBSEQsMERBR0MiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBBV1MgPSByZXF1aXJlKCdhd3Mtc2RrJyk7XHJcbmNvbnN0IGlzVGVzdCA9IHByb2Nlc3MuZW52LkpFU1RfV09SS0VSX0lEO1xyXG5jb25zdCBjb25maWcgPSB7XHJcbiAgY29udmVydEVtcHR5VmFsdWVzOiB0cnVlLFxyXG4gIC4uLihpc1Rlc3QgJiYge1xyXG4gICAgZW5kcG9pbnQ6ICdsb2NhbGhvc3Q6ODAwMCcsXHJcbiAgICBzc2xFbmFibGVkOiBmYWxzZSxcclxuICAgIHJlZ2lvbjogJ2xvY2FsLWVudicsXHJcbiAgfSksXHJcbn07XHJcbmNvbnN0IGRvY0NsaWVudCA9IG5ldyBBV1MuRHluYW1vREIuRG9jdW1lbnRDbGllbnQoY29uZmlnKTtcclxuY29uc3QgdGFibGUgPSAoaXNUZXN0KSA/IHByb2Nlc3MuZW52LkRZTkFNT19EQl9URVNUX1RBQkxFIDogcHJvY2Vzcy5lbnYuRFlOQU1PX0RCX0dBTUVfVEFCTEU7XHJcbmltcG9ydCB7IEdhbWUgfSBmcm9tIFwiLi9nYW1lXCI7XHJcbmltcG9ydCB7IEdhbWVFcnJvciB9IGZyb20gXCIuL2dhbWVFcnJvckhhbmRsZXJcIjtcclxuIFxyXG4gZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEdhbWUoZ2FtZTogR2FtZSkgOiBQcm9taXNlPEdhbWU+IHtcclxuICAgIGxldCBwYXJhbXMgPSB7XHJcbiAgICAgIFRhYmxlTmFtZTogdGFibGUsXHJcbiAgICAgIEtleToge1xyXG4gICAgICAgIHVzZXJJRDogZ2FtZS51c2VySUQsXHJcbiAgICAgICAgZ2FtZU5hbWU6IGdhbWUuZ2FtZU5hbWVcclxuICAgICAgfSxcclxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogYGdhbWVOYW1lID0gJHtnYW1lLmdhbWVOYW1lfSBBTkQgdXNlcklEID0gJHtnYW1lLnVzZXJJRH1gXHJcbiAgICB9XHJcbiAgICBcclxuICAgIHRyeSB7XHJcbiAgICAgIGxldCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5nZXQocGFyYW1zKS5wcm9taXNlKCk7XHJcbiAgICAgIGxldCBnYW1lID0gc2VyaWFsaXplRHluYW1vUmVzcG9uc2UocmVzcG9uc2UuSXRlbSk7XHJcbiAgICAgIHJldHVybiBnYW1lO1xyXG4gICAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcclxuICAgICAgLy9EeW5hbW8gcmV0dXJucyBhbiBlbXB0eSBvYmplY3QgaWYgdGhlIGdldCBjYW4ndCBmaW5kIGEgcmVjb3JkLlxyXG4gICAgICAvL05vdCBzdXJlIGhvdyB0byBoYW5kbGUgdGhpcyBzaW5jZSB0aGUgZG9jdW1lbnRDbGllbnQgZG9lc24ndCB0aHJvdyBhbiBlcnJvclxyXG4gICAgICBpZiAoZXJyLm1lc3NhZ2UgPT0gXCJDYW5ub3QgcmVhZCBwcm9wZXJ0eSAndXNlcklEJyBvZiB1bmRlZmluZWRcIikge1xyXG4gICAgICAgIHRocm93IG5ldyBHYW1lRXJyb3IoXCJVbmFibGUgdG8gZmluZCBnYW1lLlwiLCA0MDQpO1xyXG4gICAgICB9XHJcbiAgICAgIHRocm93IG5ldyBHYW1lRXJyb3IoZXJyLm1lc3NhZ2UsIGVyci5zdGF0dXNDb2RlKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxpc3RHYW1lcyh1c2VySUQ6IHN0cmluZykgOiBQcm9taXNlPFtHYW1lXT4ge1xyXG4gICAgbGV0IHBhcmFtcyA9IHtcclxuICAgICAgVGFibGVOYW1lOiB0YWJsZSxcclxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogXCIjdXNlcklEID0gOnVzZXJJRFwiLFxyXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcclxuICAgICAgICAgIFwiI3VzZXJJRFwiOiBcInVzZXJJRFwiXHJcbiAgICAgIH0sXHJcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcclxuICAgICAgICAgIFwiOnVzZXJJRFwiOiB1c2VySURcclxuICAgICAgfVxyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdHJ5IHtcclxuICAgICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnF1ZXJ5KHBhcmFtcykucHJvbWlzZSgpOyAgICAgIFxyXG4gICAgICBsZXQgZ2FtZUxpc3QgPSBbXSBhcyBhbnlcclxuICAgICAgcmVzcG9uc2UuSXRlbXMuZm9yRWFjaCgoZ2FtZTogSUR5bmFtb09iamVjdCkgPT4ge1xyXG4gICAgICAgIGxldCByZXR1cm5lZEdhbWUgPSBzZXJpYWxpemVEeW5hbW9SZXNwb25zZShnYW1lKTtcclxuICAgICAgICBnYW1lTGlzdC5wdXNoKHJldHVybmVkR2FtZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgICByZXR1cm4gZ2FtZUxpc3Q7XHJcbiAgICB9IGNhdGNoIChlcnI6IGFueSkge1xyXG4gICAgICB0aHJvdyBuZXcgR2FtZUVycm9yKGVyci5tZXNzYWdlLCBlcnIuc3RhdHVzQ29kZSlcclxuICAgIH1cclxuICB9XHJcbiAgZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG1vZGlmeUdhbWUoZ2FtZTogR2FtZSkge1xyXG4gICAgbGV0IHVwZGF0ZUV4cHJlc3Npb246IFN0cmluZ1tdID0gW107XHJcbiAgICBsZXQgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzID0ge30gYXMgYW55O1xyXG4gICAgbGV0IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMgPSB7fSBhcyBhbnk7XHJcbiAgICBcclxuICAgIC8vR2VuZXJhdGUgZHluYW1taWMgdXBkYXRlIGV4cHJlc3Npb24gYmFzZWQgb24gYWxsb3dlZCBwYXJhbWV0ZXJzXHJcbiAgICBmb3IgKGxldCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoZ2FtZSkpIHtcclxuICAgICAgaWYgKGtleSAhPSAndXNlcklEJyAmJiBrZXkgIT0gJ2dhbWVOYW1lJyAmJiB2YWx1ZSAhPSB1bmRlZmluZWQpIHtcclxuICAgICAgICB1cGRhdGVFeHByZXNzaW9uLnB1c2goYCMke2tleX0gPSA6JHtrZXl9YCk7XHJcbiAgICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzW2AjJHtrZXl9YF0gPSBrZXkgO1xyXG4gICAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbYDoke2tleX1gXSA9IHZhbHVlOyAgXHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBsZXQgcGFyYW1zID0ge1xyXG4gICAgICBUYWJsZU5hbWU6IHRhYmxlLFxyXG4gICAgICBLZXk6IHtcclxuICAgICAgICB1c2VySUQ6IGdhbWUudXNlcklELFxyXG4gICAgICAgIGdhbWVOYW1lOiBnYW1lLmdhbWVOYW1lXHJcbiAgICAgIH0sXHJcbiAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246IGBnYW1lTmFtZSA9ICR7Z2FtZS5nYW1lTmFtZX0gQU5EIHVzZXJJRCA9ICR7Z2FtZS51c2VySUR9YCxcclxuICAgICAgVXBkYXRlRXhwcmVzc2lvbjogYFNFVCAke3VwZGF0ZUV4cHJlc3Npb24uam9pbihcIixcIil9YCxcclxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiBleHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXHJcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMsXHJcbiAgICAgIENvbmRpdGlvbkV4cHJlc3Npb246ICdhdHRyaWJ1dGVfZXhpc3RzKGdhbWVOYW1lKSBhbmQgYXR0cmlidXRlX2V4aXN0cyh1c2VySUQpJyxcclxuICAgICAgUmV0dXJuVmFsdWVzOiAnQUxMX05FVydcclxuICAgIH07XHJcbiAgXHJcbiAgICB0cnkge1xyXG4gICAgICBsZXQgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQudXBkYXRlKHBhcmFtcykucHJvbWlzZSgpO1xyXG4gICAgICBsZXQgbW9kaWZpZWRHYW1lID0gYXdhaXQgZ2V0R2FtZShnYW1lKTtcclxuICAgICAgcmV0dXJuIG1vZGlmaWVkR2FtZTtcclxuICAgIH0gY2F0Y2ggKGVycjogYW55KSB7XHJcbiAgICAgIHRocm93IG5ldyBHYW1lRXJyb3IoZXJyLm1lc3NhZ2UsIGVyci5zdGF0dXNDb2RlKTtcclxuICAgIH1cclxuICB9XHJcbiAgXHJcbiAgZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRlbGV0ZUdhbWUoZ2FtZTogR2FtZSkge1xyXG4gICAgbGV0IHBhcmFtcyA9IHtcclxuICAgICAgVGFibGVOYW1lOiB0YWJsZSxcclxuICAgICAgS2V5OiB7XHJcbiAgICAgICAgdXNlcklEOiBnYW1lLnVzZXJJRCxcclxuICAgICAgICBnYW1lTmFtZTogZ2FtZS5nYW1lTmFtZSAgICAgICAgICBcclxuICAgICAgfSxcclxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogYGdhbWVOYW1lID0gJHtnYW1lLmdhbWVOYW1lfSBBTkQgdXNlcklEID0gJHtnYW1lLnVzZXJJRH1gLFxyXG4gICAgICBDb25kaXRpb25FeHByZXNzaW9uOiAnYXR0cmlidXRlX2V4aXN0cyhnYW1lTmFtZSkgYW5kIGF0dHJpYnV0ZV9leGlzdHModXNlcklEKScsXHJcbiAgICAgIFJldHVyblZhbHVlczogJ0FMTF9PTEQnXHJcbiAgICB9O1xyXG4gIFxyXG4gICAgdHJ5IHtcclxuICAgICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LmRlbGV0ZShwYXJhbXMpLnByb21pc2UoKTtcclxuICAgICAgbGV0IGdhbWUgPSBzZXJpYWxpemVEeW5hbW9SZXNwb25zZShyZXNwb25zZS5BdHRyaWJ1dGVzKTtcclxuICAgICAgcmV0dXJuIGdhbWU7ICAgICAgXHJcbiAgICB9IGNhdGNoIChlcnI6IGFueSkge1xyXG4gICAgICB0aHJvdyBuZXcgR2FtZUVycm9yKGVyci5tZXNzYWdlLCBlcnIuc3RhdHVzQ29kZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBleHBvcnQgaW50ZXJmYWNlIElKU09OUGF5bG9hZCB7XHJcbiAgICBnYW1lTmFtZTogc3RyaW5nLFxyXG4gICAgeWVhclJlbGVhc2VkPzogbnVtYmVyLFxyXG4gICAgZ2VucmU/OiBzdHJpbmcsXHJcbiAgICBjb25zb2xlPzogc3RyaW5nLFxyXG4gICAgZGV2ZWxvcGVyPzogc3RyaW5nXHJcbiB9XHJcblxyXG4gIGV4cG9ydCBpbnRlcmZhY2UgSUR5bmFtb09iamVjdCB7XHJcbiAgICAgdXNlcklEOiBzdHJpbmcsXHJcbiAgICAgZ2FtZU5hbWU6IHN0cmluZywgICAgIFxyXG4gICAgIHllYXJSZWxlYXNlZD86IG51bWJlcixcclxuICAgICBnZW5yZT86IHN0cmluZyxcclxuICAgICBjb25zb2xlPzogc3RyaW5nLFxyXG4gICAgIGRldmVsb3Blcj86IHN0cmluZ1xyXG4gIH1cclxuICBcclxuICBleHBvcnQgaW50ZXJmYWNlIElIdHRwUmVzcG9uc2Uge1xyXG4gICAgIHN0YXR1c0NvZGU6IG51bWJlcixcclxuICAgICBib2R5OiBzdHJpbmcsXHJcbiAgfVxyXG5cclxuICBleHBvcnQgZnVuY3Rpb24gc2VyaWFsaXplRHluYW1vUmVzcG9uc2UoZGF0YTogSUR5bmFtb09iamVjdCkgOiBHYW1lIHtcclxuICAgIGxldCBnYW1lID0gbmV3IEdhbWUoZGF0YS51c2VySUQsIGRhdGEuZ2FtZU5hbWUsIGRhdGE/LnllYXJSZWxlYXNlZCwgZGF0YT8uZ2VucmUsIGRhdGE/LmNvbnNvbGUsIGRhdGE/LmRldmVsb3Blcik7XHJcbiAgICByZXR1cm4gZ2FtZTtcclxuICB9Il19