"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.serializeDynamoResponse = exports.deleteGame = exports.modifyGame = exports.listGames = exports.getGame = void 0;
const AWS = require('aws-sdk');
const isTest = process.env.JEST_WORKER_ID;
const config = {
    convertEmptyValues: true,
    ...(isTest && {
        endpoint: 'localhost:8000',
        sslEnabled: false,
        region: 'local-env',
    }),
};
const docClient = new AWS.DynamoDB.DocumentClient(config);
const table = (isTest) ? process.env.DYNAMO_DB_TEST_TABLE : process.env.DYNAMO_DB_GAME_TABLE;
const game_1 = require("./game");
const gameErrorHandler_1 = require("./gameErrorHandler");
async function getGame(game) {
    let params = {
        TableName: table,
        Key: {
            userID: game.userID,
            gameName: game.gameName
        },
        KeyConditionExpression: `gameName = ${game.gameName} AND userID = ${game.userID}`
    };
    try {
        let response = await docClient.get(params).promise();
        let game = serializeDynamoResponse(response.Item);
        return game;
    }
    catch (err) {
        //Dynamo returns an empty object if the get can't find a record.
        //Not sure how to handle this since the documentClient doesn't throw an error
        if (err.message == "Cannot read property 'userID' of undefined") {
            throw new gameErrorHandler_1.GameError("Unable to find game.", 404);
        }
        throw err;
    }
}
exports.getGame = getGame;
async function listGames(userID) {
    let params = {
        TableName: table,
        KeyConditionExpression: "#userID = :userID",
        ExpressionAttributeNames: {
            "#userID": "userID"
        },
        ExpressionAttributeValues: {
            ":userID": userID
        }
    };
    try {
        let response = await docClient.query(params).promise();
        let gameList = [];
        response.Items.forEach((game) => {
            let returnedGame = serializeDynamoResponse(game);
            gameList.push(returnedGame);
        });
        return gameList;
    }
    catch (err) {
        throw err;
    }
}
exports.listGames = listGames;
async function modifyGame(game) {
    let updateExpression = [];
    let expressionAttributeNames = {};
    let expressionAttributeValues = {};
    //Generate dynammic update expression based on allowed parameters
    for (let [key, value] of Object.entries(game)) {
        if (key != 'userID' && key != 'gameName' && value != undefined) {
            updateExpression.push(`#${key} = :${key}`);
            expressionAttributeNames[`#${key}`] = key;
            expressionAttributeValues[`:${key}`] = value;
        }
    }
    let params = {
        TableName: table,
        Key: {
            userID: game.userID,
            gameName: game.gameName
        },
        KeyConditionExpression: `gameName = ${game.gameName} AND userID = ${game.userID}`,
        UpdateExpression: `SET ${updateExpression.join(",")}`,
        ExpressionAttributeNames: expressionAttributeNames,
        ExpressionAttributeValues: expressionAttributeValues,
        ConditionExpression: 'attribute_exists(gameName) and attribute_exists(userID)',
        ReturnValues: 'ALL_NEW'
    };
    try {
        let response = await docClient.update(params).promise();
        let modifiedGame = await getGame(game);
        return modifiedGame;
    }
    catch (err) {
        if (err.message == "The conditional request failed") {
            throw new gameErrorHandler_1.GameError("Unable to modify game.", 404);
        }
        throw err;
    }
}
exports.modifyGame = modifyGame;
async function deleteGame(game) {
    let params = {
        TableName: table,
        Key: {
            userID: game.userID,
            gameName: game.gameName
        },
        KeyConditionExpression: `gameName = ${game.gameName} AND userID = ${game.userID}`,
        ConditionExpression: 'attribute_exists(gameName) and attribute_exists(userID)',
        ReturnValues: 'ALL_OLD'
    };
    try {
        let response = await docClient.delete(params).promise();
        let game = serializeDynamoResponse(response.Attributes);
        return game;
    }
    catch (err) {
        if (err.message == "The conditional request failed") {
            throw new gameErrorHandler_1.GameError("Unable to find game.", 404);
        }
        throw err;
    }
}
exports.deleteGame = deleteGame;
function serializeDynamoResponse(data) {
    let game = new game_1.Game(data.userID, data.gameName, data === null || data === void 0 ? void 0 : data.yearReleased, data === null || data === void 0 ? void 0 : data.genre, data === null || data === void 0 ? void 0 : data.console, data === null || data === void 0 ? void 0 : data.developer);
    return game;
}
exports.serializeDynamoResponse = serializeDynamoResponse;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2FtZU1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnYW1lTWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDL0IsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUM7QUFDMUMsTUFBTSxNQUFNLEdBQUc7SUFDYixrQkFBa0IsRUFBRSxJQUFJO0lBQ3hCLEdBQUcsQ0FBQyxNQUFNLElBQUk7UUFDWixRQUFRLEVBQUUsZ0JBQWdCO1FBQzFCLFVBQVUsRUFBRSxLQUFLO1FBQ2pCLE1BQU0sRUFBRSxXQUFXO0tBQ3BCLENBQUM7Q0FDSCxDQUFDO0FBQ0YsTUFBTSxTQUFTLEdBQUcsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMxRCxNQUFNLEtBQUssR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDO0FBQzdGLGlDQUE4QjtBQUM5Qix5REFBK0M7QUFFdkMsS0FBSyxVQUFVLE9BQU8sQ0FBQyxJQUFVO0lBQ3JDLElBQUksTUFBTSxHQUFHO1FBQ1gsU0FBUyxFQUFFLEtBQUs7UUFDaEIsR0FBRyxFQUFFO1lBQ0gsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNO1lBQ25CLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtTQUN4QjtRQUNELHNCQUFzQixFQUFFLGNBQWMsSUFBSSxDQUFDLFFBQVEsaUJBQWlCLElBQUksQ0FBQyxNQUFNLEVBQUU7S0FDbEYsQ0FBQTtJQUVELElBQUk7UUFDRixJQUFJLFFBQVEsR0FBRyxNQUFNLFNBQVMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDckQs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LE1BQU0sRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSxZQUFZLEVBQUUsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLEtBQUssRUFBRSxJQUFJLGFBQUosSUFBSSx1QkFBSixJQUFJLENBQUUsT0FBTyxFQUFFLElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSxTQUFTLENBQUMsQ0FBQztJQUNqSCxPQUFPLElBQUksQ0FBQztBQUNkLENBQUM7QUFIRCwwREFHQyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IEFXUyA9IHJlcXVpcmUoJ2F3cy1zZGsnKTtcclxuY29uc3QgaXNUZXN0ID0gcHJvY2Vzcy5lbnYuSkVTVF9XT1JLRVJfSUQ7XHJcbmNvbnN0IGNvbmZpZyA9IHtcclxuICBjb252ZXJ0RW1wdHlWYWx1ZXM6IHRydWUsXHJcbiAgLi4uKGlzVGVzdCAmJiB7XHJcbiAgICBlbmRwb2ludDogJ2xvY2FsaG9zdDo4MDAwJyxcclxuICAgIHNzbEVuYWJsZWQ6IGZhbHNlLFxyXG4gICAgcmVnaW9uOiAnbG9jYWwtZW52JyxcclxuICB9KSxcclxufTtcclxuY29uc3QgZG9jQ2xpZW50ID0gbmV3IEFXUy5EeW5hbW9EQi5Eb2N1bWVudENsaWVudChjb25maWcpO1xyXG5jb25zdCB0YWJsZSA9IChpc1Rlc3QpID8gcHJvY2Vzcy5lbnYuRFlOQU1PX0RCX1RFU1RfVEFCTEUgOiBwcm9jZXNzLmVudi5EWU5BTU9fREJfR0FNRV9UQUJMRTtcclxuaW1wb3J0IHsgR2FtZSB9IGZyb20gXCIuL2dhbWVcIjtcclxuaW1wb3J0IHsgR2FtZUVycm9yIH0gZnJvbSBcIi4vZ2FtZUVycm9ySGFuZGxlclwiO1xyXG4gXHJcbiBleHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0R2FtZShnYW1lOiBHYW1lKSA6IFByb21pc2U8R2FtZT4ge1xyXG4gICAgbGV0IHBhcmFtcyA9IHtcclxuICAgICAgVGFibGVOYW1lOiB0YWJsZSxcclxuICAgICAgS2V5OiB7XHJcbiAgICAgICAgdXNlcklEOiBnYW1lLnVzZXJJRCxcclxuICAgICAgICBnYW1lTmFtZTogZ2FtZS5nYW1lTmFtZVxyXG4gICAgICB9LFxyXG4gICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiBgZ2FtZU5hbWUgPSAke2dhbWUuZ2FtZU5hbWV9IEFORCB1c2VySUQgPSAke2dhbWUudXNlcklEfWBcclxuICAgIH1cclxuICAgIFxyXG4gICAgdHJ5IHtcclxuICAgICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LmdldChwYXJhbXMpLnByb21pc2UoKTtcclxuICAgICAgbGV0IGdhbWUgPSBzZXJpYWxpemVEeW5hbW9SZXNwb25zZShyZXNwb25zZS5JdGVtKTtcclxuICAgICAgcmV0dXJuIGdhbWU7XHJcbiAgICB9IGNhdGNoIChlcnI6IGFueSkge1xyXG4gICAgICAvL0R5bmFtbyByZXR1cm5zIGFuIGVtcHR5IG9iamVjdCBpZiB0aGUgZ2V0IGNhbid0IGZpbmQgYSByZWNvcmQuXHJcbiAgICAgIC8vTm90IHN1cmUgaG93IHRvIGhhbmRsZSB0aGlzIHNpbmNlIHRoZSBkb2N1bWVudENsaWVudCBkb2Vzbid0IHRocm93IGFuIGVycm9yXHJcbiAgICAgIGlmIChlcnIubWVzc2FnZSA9PSBcIkNhbm5vdCByZWFkIHByb3BlcnR5ICd1c2VySUQnIG9mIHVuZGVmaW5lZFwiKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEdhbWVFcnJvcihcIlVuYWJsZSB0byBmaW5kIGdhbWUuXCIsIDQwNCk7XHJcbiAgICAgIH1cclxuICAgICAgdGhyb3cgZXJyXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBleHBvcnQgYXN5bmMgZnVuY3Rpb24gbGlzdEdhbWVzKHVzZXJJRDogc3RyaW5nKSA6IFByb21pc2U8W0dhbWVdPiB7XHJcbiAgICBsZXQgcGFyYW1zID0ge1xyXG4gICAgICBUYWJsZU5hbWU6IHRhYmxlLFxyXG4gICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiBcIiN1c2VySUQgPSA6dXNlcklEXCIsXHJcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xyXG4gICAgICAgICAgXCIjdXNlcklEXCI6IFwidXNlcklEXCJcclxuICAgICAgfSxcclxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xyXG4gICAgICAgICAgXCI6dXNlcklEXCI6IHVzZXJJRFxyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB0cnkge1xyXG4gICAgICBsZXQgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQucXVlcnkocGFyYW1zKS5wcm9taXNlKCk7ICAgICAgXHJcbiAgICAgIGxldCBnYW1lTGlzdCA9IFtdIGFzIGFueVxyXG4gICAgICByZXNwb25zZS5JdGVtcy5mb3JFYWNoKChnYW1lOiBJRHluYW1vT2JqZWN0KSA9PiB7XHJcbiAgICAgICAgbGV0IHJldHVybmVkR2FtZSA9IHNlcmlhbGl6ZUR5bmFtb1Jlc3BvbnNlKGdhbWUpO1xyXG4gICAgICAgIGdhbWVMaXN0LnB1c2gocmV0dXJuZWRHYW1lKTtcclxuICAgICAgfSk7XHJcbiAgICAgIHJldHVybiBnYW1lTGlzdDtcclxuICAgIH0gY2F0Y2ggKGVycjogYW55KSB7XHJcbiAgICAgIHRocm93IGVyclxyXG4gICAgfVxyXG4gIH1cclxuICBleHBvcnQgYXN5bmMgZnVuY3Rpb24gbW9kaWZ5R2FtZShnYW1lOiBHYW1lKSB7XHJcbiAgICBsZXQgdXBkYXRlRXhwcmVzc2lvbjogU3RyaW5nW10gPSBbXTtcclxuICAgIGxldCBleHByZXNzaW9uQXR0cmlidXRlTmFtZXMgPSB7fSBhcyBhbnk7XHJcbiAgICBsZXQgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyA9IHt9IGFzIGFueTtcclxuICAgIFxyXG4gICAgLy9HZW5lcmF0ZSBkeW5hbW1pYyB1cGRhdGUgZXhwcmVzc2lvbiBiYXNlZCBvbiBhbGxvd2VkIHBhcmFtZXRlcnNcclxuICAgIGZvciAobGV0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhnYW1lKSkge1xyXG4gICAgICBpZiAoa2V5ICE9ICd1c2VySUQnICYmIGtleSAhPSAnZ2FtZU5hbWUnICYmIHZhbHVlICE9IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIHVwZGF0ZUV4cHJlc3Npb24ucHVzaChgIyR7a2V5fSA9IDoke2tleX1gKTtcclxuICAgICAgICBleHByZXNzaW9uQXR0cmlidXRlTmFtZXNbYCMke2tleX1gXSA9IGtleSA7XHJcbiAgICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1tgOiR7a2V5fWBdID0gdmFsdWU7ICBcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGxldCBwYXJhbXMgPSB7XHJcbiAgICAgIFRhYmxlTmFtZTogdGFibGUsXHJcbiAgICAgIEtleToge1xyXG4gICAgICAgIHVzZXJJRDogZ2FtZS51c2VySUQsXHJcbiAgICAgICAgZ2FtZU5hbWU6IGdhbWUuZ2FtZU5hbWVcclxuICAgICAgfSxcclxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogYGdhbWVOYW1lID0gJHtnYW1lLmdhbWVOYW1lfSBBTkQgdXNlcklEID0gJHtnYW1lLnVzZXJJRH1gLFxyXG4gICAgICBVcGRhdGVFeHByZXNzaW9uOiBgU0VUICR7dXBkYXRlRXhwcmVzc2lvbi5qb2luKFwiLFwiKX1gLFxyXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyxcclxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcclxuICAgICAgQ29uZGl0aW9uRXhwcmVzc2lvbjogJ2F0dHJpYnV0ZV9leGlzdHMoZ2FtZU5hbWUpIGFuZCBhdHRyaWJ1dGVfZXhpc3RzKHVzZXJJRCknLFxyXG4gICAgICBSZXR1cm5WYWx1ZXM6ICdBTExfTkVXJ1xyXG4gICAgfTtcclxuICBcclxuICAgIHRyeSB7XHJcbiAgICAgIGxldCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC51cGRhdGUocGFyYW1zKS5wcm9taXNlKCk7XHJcbiAgICAgIGxldCBtb2RpZmllZEdhbWUgPSBhd2FpdCBnZXRHYW1lKGdhbWUpO1xyXG4gICAgICByZXR1cm4gbW9kaWZpZWRHYW1lO1xyXG4gICAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcclxuICAgICAgaWYgKGVyci5tZXNzYWdlID09IFwiVGhlIGNvbmRpdGlvbmFsIHJlcXVlc3QgZmFpbGVkXCIpIHtcclxuICAgICAgICB0aHJvdyBuZXcgR2FtZUVycm9yKFwiVW5hYmxlIHRvIG1vZGlmeSBnYW1lLlwiLCA0MDQpO1xyXG4gICAgICB9XHJcbiAgICAgIHRocm93IGVycjtcclxuICAgIH1cclxuICB9XHJcbiAgXHJcbiAgZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRlbGV0ZUdhbWUoZ2FtZTogR2FtZSkge1xyXG4gICAgbGV0IHBhcmFtcyA9IHtcclxuICAgICAgVGFibGVOYW1lOiB0YWJsZSxcclxuICAgICAgS2V5OiB7XHJcbiAgICAgICAgdXNlcklEOiBnYW1lLnVzZXJJRCxcclxuICAgICAgICBnYW1lTmFtZTogZ2FtZS5nYW1lTmFtZSAgICAgICAgICBcclxuICAgICAgfSxcclxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogYGdhbWVOYW1lID0gJHtnYW1lLmdhbWVOYW1lfSBBTkQgdXNlcklEID0gJHtnYW1lLnVzZXJJRH1gLFxyXG4gICAgICBDb25kaXRpb25FeHByZXNzaW9uOiAnYXR0cmlidXRlX2V4aXN0cyhnYW1lTmFtZSkgYW5kIGF0dHJpYnV0ZV9leGlzdHModXNlcklEKScsXHJcbiAgICAgIFJldHVyblZhbHVlczogJ0FMTF9PTEQnXHJcbiAgICB9O1xyXG4gIFxyXG4gICAgdHJ5IHtcclxuICAgICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LmRlbGV0ZShwYXJhbXMpLnByb21pc2UoKTtcclxuICAgICAgbGV0IGdhbWUgPSBzZXJpYWxpemVEeW5hbW9SZXNwb25zZShyZXNwb25zZS5BdHRyaWJ1dGVzKTtcclxuICAgICAgcmV0dXJuIGdhbWU7ICAgICAgXHJcbiAgICB9IGNhdGNoIChlcnI6IGFueSkge1xyXG4gICAgICBpZiAoZXJyLm1lc3NhZ2UgPT0gXCJUaGUgY29uZGl0aW9uYWwgcmVxdWVzdCBmYWlsZWRcIikge1xyXG4gICAgICAgIHRocm93IG5ldyBHYW1lRXJyb3IoXCJVbmFibGUgdG8gZmluZCBnYW1lLlwiLCA0MDQpO1xyXG4gICAgICB9XHJcbiAgICAgIHRocm93IGVycjtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGV4cG9ydCBpbnRlcmZhY2UgSUpTT05QYXlsb2FkIHtcclxuICAgIGdhbWVOYW1lOiBzdHJpbmcsXHJcbiAgICB5ZWFyUmVsZWFzZWQ/OiBudW1iZXIsXHJcbiAgICBnZW5yZT86IHN0cmluZyxcclxuICAgIGNvbnNvbGU/OiBzdHJpbmcsXHJcbiAgICBkZXZlbG9wZXI/OiBzdHJpbmdcclxuIH1cclxuXHJcbiAgZXhwb3J0IGludGVyZmFjZSBJRHluYW1vT2JqZWN0IHtcclxuICAgICB1c2VySUQ6IHN0cmluZyxcclxuICAgICBnYW1lTmFtZTogc3RyaW5nLCAgICAgXHJcbiAgICAgeWVhclJlbGVhc2VkPzogbnVtYmVyLFxyXG4gICAgIGdlbnJlPzogc3RyaW5nLFxyXG4gICAgIGNvbnNvbGU/OiBzdHJpbmcsXHJcbiAgICAgZGV2ZWxvcGVyPzogc3RyaW5nXHJcbiAgfVxyXG4gIFxyXG4gIGV4cG9ydCBpbnRlcmZhY2UgSUh0dHBSZXNwb25zZSB7XHJcbiAgICAgc3RhdHVzQ29kZTogbnVtYmVyLFxyXG4gICAgIGJvZHk6IHN0cmluZyxcclxuICB9XHJcblxyXG4gIGV4cG9ydCBmdW5jdGlvbiBzZXJpYWxpemVEeW5hbW9SZXNwb25zZShkYXRhOiBJRHluYW1vT2JqZWN0KSA6IEdhbWUge1xyXG4gICAgbGV0IGdhbWUgPSBuZXcgR2FtZShkYXRhLnVzZXJJRCwgZGF0YS5nYW1lTmFtZSwgZGF0YT8ueWVhclJlbGVhc2VkLCBkYXRhPy5nZW5yZSwgZGF0YT8uY29uc29sZSwgZGF0YT8uZGV2ZWxvcGVyKTtcclxuICAgIHJldHVybiBnYW1lO1xyXG4gIH0iXX0=