"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.serializeDynamoResponse = exports.deleteGame = exports.modifyGame = exports.listGames = exports.getGame = exports.createGame = void 0;
const AWS = require('aws-sdk');
const isTest = process.env.JEST_WORKER_ID;
const config = {
    convertEmptyValues: true,
    ...(isTest && {
        endpoint: 'localhost:8000',
        sslEnabled: false,
        region: 'local-env',
    }),
};
const docClient = new AWS.DynamoDB.DocumentClient(config);
const table = (isTest) ? process.env.DYNAMO_DB_TEST_TABLE : process.env.DYNAMO_DB_GAME_TABLE;
const game_1 = require("./game");
const gameErrorHandler_1 = require("./gameErrorHandler");
async function createGame(game) {
    let params = {
        TableName: table,
        Item: {
            partitionKey: game.partitionKey,
            sortKey: game.sortKey,
            gameName: game.gameName,
            genre: game.genre,
            yearReleased: game.yearReleased,
            developer: game.developer,
            console: game.console
        },
        ConditionExpression: 'attribute_not_exists(partitionKey) AND attribute_not_exists(sortKey)'
    };
    try {
        let response = await docClient.put(params).promise();
        let createdGame = await getGame(game);
        return game;
    }
    catch (err) {
        throw new gameErrorHandler_1.GameError(err.message, err.statusCode);
    }
}
exports.createGame = createGame;
async function getGame(game) {
    let params = {
        TableName: table,
        Key: {
            partitionKey: game.partitionKey,
            sortKey: game.sortKey
        },
        KeyConditionExpression: `sortKey = ${game.sortKey} AND partitionKey = ${game.partitionKey}`
    };
    try {
        let response = await docClient.get(params).promise();
        let game = serializeDynamoResponse(response.Item);
        return game;
    }
    catch (err) {
        //Dynamo returns an empty object if the get can't find a record.
        //Not sure how to handle this since the documentClient doesn't throw an error
        if (err.message == "Cannot read property 'partitionKey' of undefined") {
            throw new gameErrorHandler_1.GameError("Unable to find game.", 404);
        }
        throw err;
    }
}
exports.getGame = getGame;
async function listGames(userID) {
    let params = {
        TableName: table,
        KeyConditionExpression: "#partitionKey = :partitionKey AND begins_with(sortKey, :sortKey)",
        FilterExpression: "attribute_exists(gameName)",
        ExpressionAttributeNames: {
            "#partitionKey": "partitionKey",
        },
        ExpressionAttributeValues: {
            ":partitionKey": `[User]#[${userID}]`,
            ":sortKey": "[GameItem]"
        }
    };
    try {
        let response = await docClient.query(params).promise();
        let gameList = [];
        response.Items.forEach((game) => {
            let returnedGame = serializeDynamoResponse(game);
            gameList.push(returnedGame);
        });
        return gameList;
    }
    catch (err) {
        throw err;
    }
}
exports.listGames = listGames;
async function modifyGame(game) {
    let updateExpression = [];
    let expressionAttributeNames = {};
    let expressionAttributeValues = {};
    //Generate dynammic update expression based on allowed parameters
    for (let [key, value] of Object.entries(game)) {
        if (key != 'partitionKey' && key != 'gameName' && key != 'sortKey' && value != undefined) {
            updateExpression.push(`#${key} = :${key}`);
            expressionAttributeNames[`#${key}`] = key;
            expressionAttributeValues[`:${key}`] = value;
        }
    }
    let params = {
        TableName: table,
        Key: {
            partitionKey: game.partitionKey,
            sortKey: game.sortKey
        },
        KeyConditionExpression: `sortKey = ${game.sortKey} AND partitionKey = ${game.partitionKey}`,
        UpdateExpression: `SET ${updateExpression.join(",")}`,
        ExpressionAttributeNames: expressionAttributeNames,
        ExpressionAttributeValues: expressionAttributeValues,
        ConditionExpression: 'attribute_exists(partitionKey) and attribute_exists(sortKey)',
        ReturnValues: 'ALL_NEW'
    };
    try {
        let response = await docClient.update(params).promise();
        let modifiedGame = await getGame(game);
        return modifiedGame;
    }
    catch (err) {
        if (err.message == "The conditional request failed") {
            throw new gameErrorHandler_1.GameError("Unable to modify game.", 400);
        }
        throw err;
    }
}
exports.modifyGame = modifyGame;
async function deleteGame(game) {
    let params = {
        TableName: table,
        Key: {
            partitionKey: game.partitionKey,
            sortKey: game.sortKey
        },
        KeyConditionExpression: `sortKey = ${game.sortKey} AND partitionKey = ${game.partitionKey}`,
        ConditionExpression: 'attribute_exists(sortKey) and attribute_exists(partitionKey)',
        ReturnValues: 'ALL_OLD'
    };
    try {
        let response = await docClient.delete(params).promise();
        let game = serializeDynamoResponse(response.Attributes);
        return game;
    }
    catch (err) {
        if (err.message == "The conditional request failed") {
            throw new gameErrorHandler_1.GameError("Unable to delete game.", 400);
        }
        throw err;
    }
}
exports.deleteGame = deleteGame;
function serializeDynamoResponse(data) {
    let game = new game_1.Game(data.partitionKey, data.sortKey, data.gameName, data === null || data === void 0 ? void 0 : data.yearReleased, data === null || data === void 0 ? void 0 : data.genre, data === null || data === void 0 ? void 0 : data.console, data === null || data === void 0 ? void 0 : data.developer);
    return game;
}
exports.serializeDynamoResponse = serializeDynamoResponse;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2FtZU1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnYW1lTWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDL0IsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUM7QUFDMUMsTUFBTSxNQUFNLEdBQUc7SUFDYixrQkFBa0IsRUFBRSxJQUFJO0lBQ3hCLEdBQUcsQ0FBQyxNQUFNLElBQUk7UUFDWixRQUFRLEVBQUUsZ0JBQWdCO1FBQzFCLFVBQVUsRUFBRSxLQUFLO1FBQ2pCLE1BQU0sRUFBRSxXQUFXO0tBQ3BCLENBQUM7Q0FDSCxDQUFDO0FBQ0YsTUFBTSxTQUFTLEdBQUcsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMxRCxNQUFNLEtBQUssR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDO0FBQzdGLGlDQUE4QjtBQUM5Qix5REFBK0M7QUFFdEMsS0FBSyxVQUFVLFVBQVUsQ0FBQyxJQUFVO0lBQ3pDLElBQUksTUFBTSxHQUFHO1FBQ1gsU0FBUyxFQUFFLEtBQUs7UUFDaEIsSUFBSSxFQUFFO1lBQ0osWUFBWSxFQUFFLElBQUksQ0FBQyxZQUFZO1lBQy9CLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTztZQUNyQixRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7WUFDdkIsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO1lBQ2pCLFlBQVksRUFBRSxJQUFJLENBQUMsWUFBWTtZQUMvQixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDekIsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO1NBQ3RCO1FBQ0QsbUJBQW1CLEVBQUUsc0VBQXNFO0tBQzVGLENBQUE7SUFFRCxJQUFJO1FBQ0YsSUFBSSxRQUFRLEdBQUcsTUFBTSxTQUFTLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3JELElBQUksV0FBVyxHQUFHLE1BQU0sT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3RDLE9BQU8sSUFBSSxDQUFDO0tBQ2I7SUFBQyxPQUFNLEdBQVEsRUFBRTtRQUNoQixNQUFNLElBQUksNEJBQVMsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztLQUNsRDtBQUNILENBQUM7QUF0QkQsZ0NBc0JDO0FBRUssS0FBSyxVQUFVLE9BQU8sQ0FBQyxJQUFVO0lBQ3JDLElBQUksTUFBTSxHQUFHO1FBQ1gsU0FBUyxFQUFFLEtBQUs7UUFDaEIsR0FBRyxFQUFFO1lBQ0gsWUFBWSxFQUFFLElBQUksQ0FBQyxZQUFZO1lBQy9CLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTztTQUN0QjtRQUNELHNCQUFzQixFQUFFLGFBQWEsSUFBSSxDQUFDLE9BQU8sdUJBQXVCLElBQUksQ0FBQyxZQUFZLEVBQUU7S0FDNUYsQ0FBQTtJQUVELElBQUk7UUFDRixJQUFJLFFBQVEsR0FBRyxNQUFNLFNBQVMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDckQsSUFBSSxJQUFJLEdBQUcsdUJBQXVCLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2xELE9BQU8sSUFBSSxDQUFDO0tBQ2I7SUFBQyxPQUFPLEdBQVEsRUFBRTtRQUNqQixnRUFBZ0U7UUFDaEUsNkVBQTZFO1FBQzdFLElBQUksR0FBRyxDQUFDLE9BQU8sSUFBSSxrREFBa0QsRUFBRTtZQUNyRSxNQUFNLElBQUksNEJBQVMsQ0FBQyxzQkFBc0IsRUFBRSxHQUFHLENBQUMsQ0FBQztTQUNsRDtRQUNELE1BQU0sR0FBRyxDQUFBO0tBQ1Y7QUFDSCxDQUFDO0FBdEJGLDBCQXNCRTtBQUVNLEtBQUssVUFBVSxTQUFTLENBQUMsTUFBYztJQUM1QyxJQUFJLE1BQU0sR0FBRztRQUNYLFNBQVMsRUFBRSxLQUFLO1FBQ2hCLHNCQUFzQixFQUFFLGtFQUFrRTtRQUMxRixnQkFBZ0IsRUFBRSw0QkFBNEI7UUFDOUMsd0JBQXdCLEVBQUU7WUFDdEIsZUFBZSxFQUFFLGNBQWM7U0FDbEM7UUFDRCx5QkFBeUIsRUFBRTtZQUN2QixlQUFlLEVBQUUsV0FBVyxNQUFNLEdBQUc7WUFDckMsVUFBVSxFQUFFLFlBQVk7U0FDM0I7S0FDRixDQUFDO0lBRUYsSUFBSTtRQUNGLElBQUksUUFBUSxHQUFHLE1BQU0sU0FBUyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUN2RCxJQUFJLFFBQVEsR0FBRyxFQUFTLENBQUE7UUFDeEIsUUFBUSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFtQixFQUFFLEVBQUU7WUFDN0MsSUFBSSxZQUFZLEdBQUcsdUJBQXVCLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDakQsUUFBUSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUM5QixDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sUUFBUSxDQUFDO0tBQ2pCO0lBQUMsT0FBTyxHQUFRLEVBQUU7UUFDakIsTUFBTSxHQUFHLENBQUE7S0FDVjtBQUNILENBQUM7QUF6QkQsOEJBeUJDO0FBQ00sS0FBSyxVQUFVLFVBQVUsQ0FBQyxJQUFVO0lBQ3pDLElBQUksZ0JBQWdCLEdBQWEsRUFBRSxDQUFDO0lBQ3BDLElBQUksd0JBQXdCLEdBQUcsRUFBUyxDQUFDO0lBQ3pDLElBQUkseUJBQXlCLEdBQUcsRUFBUyxDQUFDO0lBRTFDLGlFQUFpRTtJQUNqRSxLQUFLLElBQUksQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUM3QyxJQUFJLEdBQUcsSUFBSSxjQUFjLElBQUksR0FBRyxJQUFJLFVBQVUsSUFBSSxHQUFHLElBQUksU0FBUyxJQUFJLEtBQUssSUFBSSxTQUFTLEVBQUU7WUFDeEYsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxPQUFPLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDM0Msd0JBQXdCLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBRTtZQUMzQyx5QkFBeUIsQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDO1NBQzlDO0tBQ0Y7SUFFRCxJQUFJLE1BQU0sR0FBRztRQUNYLFNBQVMsRUFBRSxLQUFLO1FBQ2hCLEdBQUcsRUFBRTtZQUNILFlBQVksRUFBRSxJQUFJLENBQUMsWUFBWTtZQUMvQixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87U0FDdEI7UUFDRCxzQkFBc0IsRUFBRSxhQUFhLElBQUksQ0FBQyxPQUFPLHVCQUF1QixJQUFJLENBQUMsWUFBWSxFQUFFO1FBQzNGLGdCQUFnQixFQUFFLE9BQU8sZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1FBQ3JELHdCQUF3QixFQUFFLHdCQUF3QjtRQUNsRCx5QkFBeUIsRUFBRSx5QkFBeUI7UUFDcEQsbUJBQW1CLEVBQUUsOERBQThEO1FBQ25GLFlBQVksRUFBRSxTQUFTO0tBQ3hCLENBQUM7SUFFRixJQUFJO1FBQ0YsSUFBSSxRQUFRLEdBQUcsTUFBTSxTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3hELElBQUksWUFBWSxHQUFHLE1BQU0sT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3ZDLE9BQU8sWUFBWSxDQUFDO0tBQ3JCO0lBQUMsT0FBTyxHQUFRLEVBQUU7UUFDakIsSUFBSSxHQUFHLENBQUMsT0FBTyxJQUFJLGdDQUFnQyxFQUFFO1lBQ25ELE1BQU0sSUFBSSw0QkFBUyxDQUFDLHdCQUF3QixFQUFFLEdBQUcsQ0FBQyxDQUFDO1NBQ3BEO1FBQ0QsTUFBTSxHQUFHLENBQUM7S0FDWDtBQUNILENBQUM7QUF0Q0QsZ0NBc0NDO0FBRU0sS0FBSyxVQUFVLFVBQVUsQ0FBQyxJQUFVO0lBQ3pDLElBQUksTUFBTSxHQUFHO1FBQ1gsU0FBUyxFQUFFLEtBQUs7UUFDaEIsR0FBRyxFQUFFO1lBQ0gsWUFBWSxFQUFFLElBQUksQ0FBQyxZQUFZO1lBQy9CLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTztTQUN0QjtRQUNELHNCQUFzQixFQUFFLGFBQWEsSUFBSSxDQUFDLE9BQU8sdUJBQXVCLElBQUksQ0FBQyxZQUFZLEVBQUU7UUFDM0YsbUJBQW1CLEVBQUUsOERBQThEO1FBQ25GLFlBQVksRUFBRSxTQUFTO0tBQ3hCLENBQUM7SUFFRixJQUFJO1FBQ0YsSUFBSSxRQUFRLEdBQUcsTUFBTSxTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3hELElBQUksSUFBSSxHQUFHLHVCQUF1QixDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN4RCxPQUFPLElBQUksQ0FBQztLQUNiO0lBQUMsT0FBTyxHQUFRLEVBQUU7UUFDakIsSUFBSSxHQUFHLENBQUMsT0FBTyxJQUFJLGdDQUFnQyxFQUFFO1lBQ25ELE1BQU0sSUFBSSw0QkFBUyxDQUFDLHdCQUF3QixFQUFFLEdBQUcsQ0FBQyxDQUFDO1NBQ3BEO1FBQ0QsTUFBTSxHQUFHLENBQUM7S0FDWDtBQUNILENBQUM7QUF0QkQsZ0NBc0JDO0FBeUJELFNBQWdCLHVCQUF1QixDQUFDLElBQW1CO0lBQ3pELElBQUksSUFBSSxHQUFHLElBQUksV0FBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSxZQUFZLEVBQUUsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLEtBQUssRUFBRSxJQUFJLGFBQUosSUFBSSx1QkFBSixJQUFJLENBQUUsT0FBTyxFQUFFLElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSxTQUFTLENBQUMsQ0FBQztJQUNySSxPQUFPLElBQUksQ0FBQztBQUNkLENBQUM7QUFIRCwwREFHQyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IEFXUyA9IHJlcXVpcmUoJ2F3cy1zZGsnKTtcclxuY29uc3QgaXNUZXN0ID0gcHJvY2Vzcy5lbnYuSkVTVF9XT1JLRVJfSUQ7XHJcbmNvbnN0IGNvbmZpZyA9IHtcclxuICBjb252ZXJ0RW1wdHlWYWx1ZXM6IHRydWUsXHJcbiAgLi4uKGlzVGVzdCAmJiB7XHJcbiAgICBlbmRwb2ludDogJ2xvY2FsaG9zdDo4MDAwJyxcclxuICAgIHNzbEVuYWJsZWQ6IGZhbHNlLFxyXG4gICAgcmVnaW9uOiAnbG9jYWwtZW52JyxcclxuICB9KSxcclxufTtcclxuY29uc3QgZG9jQ2xpZW50ID0gbmV3IEFXUy5EeW5hbW9EQi5Eb2N1bWVudENsaWVudChjb25maWcpO1xyXG5jb25zdCB0YWJsZSA9IChpc1Rlc3QpID8gcHJvY2Vzcy5lbnYuRFlOQU1PX0RCX1RFU1RfVEFCTEUgOiBwcm9jZXNzLmVudi5EWU5BTU9fREJfR0FNRV9UQUJMRTtcclxuaW1wb3J0IHsgR2FtZSB9IGZyb20gXCIuL2dhbWVcIjtcclxuaW1wb3J0IHsgR2FtZUVycm9yIH0gZnJvbSBcIi4vZ2FtZUVycm9ySGFuZGxlclwiO1xyXG4gXHJcbiAgZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUdhbWUoZ2FtZTogR2FtZSk6IFByb21pc2U8R2FtZT4ge1xyXG4gICAgbGV0IHBhcmFtcyA9IHtcclxuICAgICAgVGFibGVOYW1lOiB0YWJsZSxcclxuICAgICAgSXRlbToge1xyXG4gICAgICAgIHBhcnRpdGlvbktleTogZ2FtZS5wYXJ0aXRpb25LZXksXHJcbiAgICAgICAgc29ydEtleTogZ2FtZS5zb3J0S2V5LFxyXG4gICAgICAgIGdhbWVOYW1lOiBnYW1lLmdhbWVOYW1lLCAgICAgICAgICBcclxuICAgICAgICBnZW5yZTogZ2FtZS5nZW5yZSxcclxuICAgICAgICB5ZWFyUmVsZWFzZWQ6IGdhbWUueWVhclJlbGVhc2VkLFxyXG4gICAgICAgIGRldmVsb3BlcjogZ2FtZS5kZXZlbG9wZXIsXHJcbiAgICAgICAgY29uc29sZTogZ2FtZS5jb25zb2xlXHJcbiAgICAgIH0sXHJcbiAgICAgIENvbmRpdGlvbkV4cHJlc3Npb246ICdhdHRyaWJ1dGVfbm90X2V4aXN0cyhwYXJ0aXRpb25LZXkpIEFORCBhdHRyaWJ1dGVfbm90X2V4aXN0cyhzb3J0S2V5KSdcclxuICAgIH1cclxuICAgIFxyXG4gICAgdHJ5IHtcclxuICAgICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnB1dChwYXJhbXMpLnByb21pc2UoKTtcclxuICAgICAgbGV0IGNyZWF0ZWRHYW1lID0gYXdhaXQgZ2V0R2FtZShnYW1lKTsgICAgICAgICAgICAgXHJcbiAgICAgIHJldHVybiBnYW1lO1xyXG4gICAgfSBjYXRjaChlcnI6IGFueSkge1xyXG4gICAgICB0aHJvdyBuZXcgR2FtZUVycm9yKGVyci5tZXNzYWdlLCBlcnIuc3RhdHVzQ29kZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuIGV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRHYW1lKGdhbWU6IEdhbWUpIDogUHJvbWlzZTxHYW1lPiB7XHJcbiAgICBsZXQgcGFyYW1zID0ge1xyXG4gICAgICBUYWJsZU5hbWU6IHRhYmxlLFxyXG4gICAgICBLZXk6IHtcclxuICAgICAgICBwYXJ0aXRpb25LZXk6IGdhbWUucGFydGl0aW9uS2V5LFxyXG4gICAgICAgIHNvcnRLZXk6IGdhbWUuc29ydEtleVxyXG4gICAgICB9LFxyXG4gICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiBgc29ydEtleSA9ICR7Z2FtZS5zb3J0S2V5fSBBTkQgcGFydGl0aW9uS2V5ID0gJHtnYW1lLnBhcnRpdGlvbktleX1gXHJcbiAgICB9XHJcbiAgICBcclxuICAgIHRyeSB7XHJcbiAgICAgIGxldCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5nZXQocGFyYW1zKS5wcm9taXNlKCk7XHJcbiAgICAgIGxldCBnYW1lID0gc2VyaWFsaXplRHluYW1vUmVzcG9uc2UocmVzcG9uc2UuSXRlbSk7XHJcbiAgICAgIHJldHVybiBnYW1lO1xyXG4gICAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcclxuICAgICAgLy9EeW5hbW8gcmV0dXJucyBhbiBlbXB0eSBvYmplY3QgaWYgdGhlIGdldCBjYW4ndCBmaW5kIGEgcmVjb3JkLlxyXG4gICAgICAvL05vdCBzdXJlIGhvdyB0byBoYW5kbGUgdGhpcyBzaW5jZSB0aGUgZG9jdW1lbnRDbGllbnQgZG9lc24ndCB0aHJvdyBhbiBlcnJvclxyXG4gICAgICBpZiAoZXJyLm1lc3NhZ2UgPT0gXCJDYW5ub3QgcmVhZCBwcm9wZXJ0eSAncGFydGl0aW9uS2V5JyBvZiB1bmRlZmluZWRcIikge1xyXG4gICAgICAgIHRocm93IG5ldyBHYW1lRXJyb3IoXCJVbmFibGUgdG8gZmluZCBnYW1lLlwiLCA0MDQpO1xyXG4gICAgICB9XHJcbiAgICAgIHRocm93IGVyclxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxpc3RHYW1lcyh1c2VySUQ6IHN0cmluZykgOiBQcm9taXNlPFtHYW1lXT4ge1xyXG4gICAgbGV0IHBhcmFtcyA9IHtcclxuICAgICAgVGFibGVOYW1lOiB0YWJsZSxcclxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogXCIjcGFydGl0aW9uS2V5ID0gOnBhcnRpdGlvbktleSBBTkQgYmVnaW5zX3dpdGgoc29ydEtleSwgOnNvcnRLZXkpXCIsXHJcbiAgICAgIEZpbHRlckV4cHJlc3Npb246IFwiYXR0cmlidXRlX2V4aXN0cyhnYW1lTmFtZSlcIixcclxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XHJcbiAgICAgICAgICBcIiNwYXJ0aXRpb25LZXlcIjogXCJwYXJ0aXRpb25LZXlcIixcclxuICAgICAgfSxcclxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xyXG4gICAgICAgICAgXCI6cGFydGl0aW9uS2V5XCI6IGBbVXNlcl0jWyR7dXNlcklEfV1gLFxyXG4gICAgICAgICAgXCI6c29ydEtleVwiOiBcIltHYW1lSXRlbV1cIlxyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB0cnkge1xyXG4gICAgICBsZXQgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQucXVlcnkocGFyYW1zKS5wcm9taXNlKCk7ICAgICAgXHJcbiAgICAgIGxldCBnYW1lTGlzdCA9IFtdIGFzIGFueVxyXG4gICAgICByZXNwb25zZS5JdGVtcy5mb3JFYWNoKChnYW1lOiBJRHluYW1vT2JqZWN0KSA9PiB7XHJcbiAgICAgICAgbGV0IHJldHVybmVkR2FtZSA9IHNlcmlhbGl6ZUR5bmFtb1Jlc3BvbnNlKGdhbWUpO1xyXG4gICAgICAgIGdhbWVMaXN0LnB1c2gocmV0dXJuZWRHYW1lKTtcclxuICAgICAgfSk7XHJcbiAgICAgIHJldHVybiBnYW1lTGlzdDtcclxuICAgIH0gY2F0Y2ggKGVycjogYW55KSB7XHJcbiAgICAgIHRocm93IGVyclxyXG4gICAgfVxyXG4gIH1cclxuICBleHBvcnQgYXN5bmMgZnVuY3Rpb24gbW9kaWZ5R2FtZShnYW1lOiBHYW1lKSB7XHJcbiAgICBsZXQgdXBkYXRlRXhwcmVzc2lvbjogU3RyaW5nW10gPSBbXTtcclxuICAgIGxldCBleHByZXNzaW9uQXR0cmlidXRlTmFtZXMgPSB7fSBhcyBhbnk7XHJcbiAgICBsZXQgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyA9IHt9IGFzIGFueTtcclxuICAgIFxyXG4gICAgLy9HZW5lcmF0ZSBkeW5hbW1pYyB1cGRhdGUgZXhwcmVzc2lvbiBiYXNlZCBvbiBhbGxvd2VkIHBhcmFtZXRlcnNcclxuICAgIGZvciAobGV0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhnYW1lKSkge1xyXG4gICAgICBpZiAoa2V5ICE9ICdwYXJ0aXRpb25LZXknICYmIGtleSAhPSAnZ2FtZU5hbWUnICYmIGtleSAhPSAnc29ydEtleScgJiYgdmFsdWUgIT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgdXBkYXRlRXhwcmVzc2lvbi5wdXNoKGAjJHtrZXl9ID0gOiR7a2V5fWApO1xyXG4gICAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1tgIyR7a2V5fWBdID0ga2V5IDtcclxuICAgICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzW2A6JHtrZXl9YF0gPSB2YWx1ZTsgIFxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IHBhcmFtcyA9IHtcclxuICAgICAgVGFibGVOYW1lOiB0YWJsZSxcclxuICAgICAgS2V5OiB7XHJcbiAgICAgICAgcGFydGl0aW9uS2V5OiBnYW1lLnBhcnRpdGlvbktleSxcclxuICAgICAgICBzb3J0S2V5OiBnYW1lLnNvcnRLZXlcclxuICAgICAgfSxcclxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogYHNvcnRLZXkgPSAke2dhbWUuc29ydEtleX0gQU5EIHBhcnRpdGlvbktleSA9ICR7Z2FtZS5wYXJ0aXRpb25LZXl9YCxcclxuICAgICAgVXBkYXRlRXhwcmVzc2lvbjogYFNFVCAke3VwZGF0ZUV4cHJlc3Npb24uam9pbihcIixcIil9YCxcclxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiBleHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXHJcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMsXHJcbiAgICAgIENvbmRpdGlvbkV4cHJlc3Npb246ICdhdHRyaWJ1dGVfZXhpc3RzKHBhcnRpdGlvbktleSkgYW5kIGF0dHJpYnV0ZV9leGlzdHMoc29ydEtleSknLFxyXG4gICAgICBSZXR1cm5WYWx1ZXM6ICdBTExfTkVXJ1xyXG4gICAgfTtcclxuICBcclxuICAgIHRyeSB7XHJcbiAgICAgIGxldCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC51cGRhdGUocGFyYW1zKS5wcm9taXNlKCk7XHJcbiAgICAgIGxldCBtb2RpZmllZEdhbWUgPSBhd2FpdCBnZXRHYW1lKGdhbWUpO1xyXG4gICAgICByZXR1cm4gbW9kaWZpZWRHYW1lO1xyXG4gICAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcclxuICAgICAgaWYgKGVyci5tZXNzYWdlID09IFwiVGhlIGNvbmRpdGlvbmFsIHJlcXVlc3QgZmFpbGVkXCIpIHtcclxuICAgICAgICB0aHJvdyBuZXcgR2FtZUVycm9yKFwiVW5hYmxlIHRvIG1vZGlmeSBnYW1lLlwiLCA0MDApO1xyXG4gICAgICB9XHJcbiAgICAgIHRocm93IGVycjtcclxuICAgIH1cclxuICB9XHJcbiAgXHJcbiAgZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRlbGV0ZUdhbWUoZ2FtZTogR2FtZSkge1xyXG4gICAgbGV0IHBhcmFtcyA9IHtcclxuICAgICAgVGFibGVOYW1lOiB0YWJsZSxcclxuICAgICAgS2V5OiB7XHJcbiAgICAgICAgcGFydGl0aW9uS2V5OiBnYW1lLnBhcnRpdGlvbktleSxcclxuICAgICAgICBzb3J0S2V5OiBnYW1lLnNvcnRLZXlcclxuICAgICAgfSxcclxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogYHNvcnRLZXkgPSAke2dhbWUuc29ydEtleX0gQU5EIHBhcnRpdGlvbktleSA9ICR7Z2FtZS5wYXJ0aXRpb25LZXl9YCxcclxuICAgICAgQ29uZGl0aW9uRXhwcmVzc2lvbjogJ2F0dHJpYnV0ZV9leGlzdHMoc29ydEtleSkgYW5kIGF0dHJpYnV0ZV9leGlzdHMocGFydGl0aW9uS2V5KScsXHJcbiAgICAgIFJldHVyblZhbHVlczogJ0FMTF9PTEQnXHJcbiAgICB9O1xyXG4gIFxyXG4gICAgdHJ5IHtcclxuICAgICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LmRlbGV0ZShwYXJhbXMpLnByb21pc2UoKTtcclxuICAgICAgbGV0IGdhbWUgPSBzZXJpYWxpemVEeW5hbW9SZXNwb25zZShyZXNwb25zZS5BdHRyaWJ1dGVzKTtcclxuICAgICAgcmV0dXJuIGdhbWU7ICAgICAgXHJcbiAgICB9IGNhdGNoIChlcnI6IGFueSkge1xyXG4gICAgICBpZiAoZXJyLm1lc3NhZ2UgPT0gXCJUaGUgY29uZGl0aW9uYWwgcmVxdWVzdCBmYWlsZWRcIikge1xyXG4gICAgICAgIHRocm93IG5ldyBHYW1lRXJyb3IoXCJVbmFibGUgdG8gZGVsZXRlIGdhbWUuXCIsIDQwMCk7XHJcbiAgICAgIH1cclxuICAgICAgdGhyb3cgZXJyO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZXhwb3J0IGludGVyZmFjZSBJSlNPTlBheWxvYWQge1xyXG4gICAgZ2FtZU5hbWU6IHN0cmluZyxcclxuICAgIHllYXJSZWxlYXNlZD86IG51bWJlcixcclxuICAgIGdlbnJlPzogc3RyaW5nLFxyXG4gICAgY29uc29sZT86IHN0cmluZyxcclxuICAgIGRldmVsb3Blcj86IHN0cmluZ1xyXG4gfVxyXG5cclxuICBleHBvcnQgaW50ZXJmYWNlIElEeW5hbW9PYmplY3Qge1xyXG4gICAgIHBhcnRpdGlvbktleTogc3RyaW5nLCAgIFxyXG4gICAgIHNvcnRLZXk6IHN0cmluZyxcclxuICAgICBnYW1lTmFtZTogc3RyaW5nLFxyXG4gICAgIHllYXJSZWxlYXNlZD86IG51bWJlcixcclxuICAgICBnZW5yZT86IHN0cmluZyxcclxuICAgICBjb25zb2xlPzogc3RyaW5nLFxyXG4gICAgIGRldmVsb3Blcj86IHN0cmluZ1xyXG4gIH1cclxuICBcclxuICBleHBvcnQgaW50ZXJmYWNlIElIdHRwUmVzcG9uc2Uge1xyXG4gICAgIHN0YXR1c0NvZGU6IG51bWJlcixcclxuICAgICBib2R5OiBzdHJpbmcsXHJcbiAgfVxyXG5cclxuICBleHBvcnQgZnVuY3Rpb24gc2VyaWFsaXplRHluYW1vUmVzcG9uc2UoZGF0YTogSUR5bmFtb09iamVjdCkgOiBHYW1lIHtcclxuICAgIGxldCBnYW1lID0gbmV3IEdhbWUoZGF0YS5wYXJ0aXRpb25LZXksIGRhdGEuc29ydEtleSwgZGF0YS5nYW1lTmFtZSwgZGF0YT8ueWVhclJlbGVhc2VkLCBkYXRhPy5nZW5yZSwgZGF0YT8uY29uc29sZSwgZGF0YT8uZGV2ZWxvcGVyKTtcclxuICAgIHJldHVybiBnYW1lO1xyXG4gIH0iXX0=