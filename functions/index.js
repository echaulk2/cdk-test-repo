"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.HttpResponse = exports.deleteGame = exports.modifyGame = exports.createGame = exports.listGames = exports.getGame = void 0;
const AWS = require('aws-sdk');
const docClient = new AWS.DynamoDB.DocumentClient();
const table = process.env.DYNAMO_DB_TABLE;
const Modules_1 = require("./Modules");
const allowedRequestParameters = JSON.parse(process.env.ALLOWED_REQUEST_PARAMETERS);
exports.handler = async (event, context, callback) => {
    switch (event.path) {
        case ("/getGame"):
            let getGameData = (0, Modules_1.SerializeGameData)({ gameName: event.queryStringParameters["gameName"] });
            callback(null, await getGame(getGameData.gameName));
            break;
        case ("/listGames"):
            callback(null, await listGames());
            break;
        case ("/createGame"):
            let createGameData = (0, Modules_1.SerializeGameData)(JSON.parse(event.body));
            callback(null, await createGame(createGameData));
            break;
        case ("/modifyGame"):
            let modifyGameData = (0, Modules_1.SerializeGameData)(JSON.parse(event.body));
            callback(null, await modifyGame(modifyGameData));
            break;
        case ("/deleteGame"):
            let deleteGameData = (0, Modules_1.SerializeGameData)(JSON.parse(event.body));
            callback(null, await deleteGame(deleteGameData.gameName));
            break;
        default:
            callback(null, HttpResponse({ statusCode: 400, body: JSON.stringify("Invalid operation.") }));
            break;
    }
};
async function getGame(gameName) {
    let params = {
        TableName: table,
        Key: {
            gameName: gameName
        }
    };
    try {
        let response = await docClient.get(params).promise();
        if (response.Item) {
            let game = (0, Modules_1.SerializeGameData)(response.Item);
            return HttpResponse({ statusCode: 200, body: JSON.stringify(game) });
        }
        else {
            return HttpResponse({ statusCode: 404, body: "Unable to find game." });
        }
    }
    catch (err) {
        return HttpResponse({ statusCode: 400, body: "Unable to find game." });
    }
}
exports.getGame = getGame;
async function listGames() {
    let params = {
        TableName: table,
        Select: "ALL_ATTRIBUTES"
    };
    try {
        let response = await docClient.scan(params).promise();
        let gameList = [];
        if (response.Items) {
            response.Items.forEach((game) => {
                gameList.push((0, Modules_1.SerializeGameData)(game));
            });
            return HttpResponse({ statusCode: 200, body: JSON.stringify(gameList) });
        }
        else {
            return HttpResponse({ statusCode: 404, body: 'Game list could not be found.' });
        }
    }
    catch (err) {
        return HttpResponse({ statusCode: 400, body: 'Game list could not be found.' });
    }
}
exports.listGames = listGames;
async function createGame(game) {
    let params = {
        TableName: table,
        Item: {
            gameName: game.gameName,
            genre: game.genre,
            yearReleased: game.yearReleased,
            developer: game.developer,
            console: game.console
        },
        ConditionExpression: 'attribute_not_exists(gameName)'
    };
    try {
        let response = await docClient.put(params).promise();
        if (Object.keys(response).length == 0) {
            return HttpResponse({ statusCode: 201, body: JSON.stringify(game) });
        }
        else {
            return HttpResponse({ statusCode: 403, body: 'Unable to create game.' });
        }
    }
    catch (err) {
        return HttpResponse({ statusCode: 400, body: 'Unable to create game.' });
    }
}
exports.createGame = createGame;
async function modifyGame(game) {
    let updateExpression = [];
    let expressionAttributeNames = {};
    let expressionAttributeValues = {};
    //Generate dynammic update expression based on allowed parameters
    for (let [key, value] of Object.entries(game)) {
        if (allowedRequestParameters.includes(key) && value != undefined) {
            updateExpression.push(`#${key} = :${key}`);
            expressionAttributeNames['#' + key] = key;
            expressionAttributeValues[':' + key] = `${value}`;
        }
    }
    let params = {
        TableName: table,
        Key: {
            gameName: game.gameName
        },
        UpdateExpression: `SET ${updateExpression.join(",")}`,
        ExpressionAttributeNames: expressionAttributeNames,
        ExpressionAttributeValues: expressionAttributeValues,
        ConditionExpression: 'attribute_exists(gameName)',
        ReturnValues: 'ALL_NEW'
    };
    try {
        let response = await docClient.update(params).promise();
        if (response.Attributes) {
            let modifiedGame = (0, Modules_1.SerializeGameData)(response.Attributes);
            return HttpResponse({ statusCode: 200, body: JSON.stringify(modifiedGame) });
        }
        else {
            return HttpResponse({ statusCode: 403, body: 'Unable to modify game.' });
        }
    }
    catch (err) {
        return HttpResponse({ statusCode: 400, body: 'Unable to modify game.' });
    }
}
exports.modifyGame = modifyGame;
async function deleteGame(gameName) {
    let params = {
        TableName: table,
        Key: {
            gameName: gameName
        },
        ReturnValues: 'ALL_OLD'
    };
    try {
        let response = await docClient.delete(params).promise();
        if (response.Attributes) {
            let deletedGame = (0, Modules_1.SerializeGameData)(response.Attributes);
            return HttpResponse({ statusCode: 200, body: JSON.stringify(deletedGame) });
        }
        else {
            return HttpResponse({ statusCode: 404, body: 'Unable to delete game.' });
        }
    }
    catch (err) {
        return HttpResponse({ statusCode: 400, body: 'Unable to delete game.' });
    }
}
exports.deleteGame = deleteGame;
function HttpResponse(data) {
    return {
        statusCode: data.statusCode,
        body: data.body,
        headers: {
            'Access-Control-Allow-Origin': '*'
        }
    };
}
exports.HttpResponse = HttpResponse;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDL0IsTUFBTSxTQUFTLEdBQUcsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLGNBQWMsRUFBRSxDQUFDO0FBQ3BELE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDO0FBRTFDLHVDQUFnRjtBQUNoRixNQUFNLHdCQUF3QixHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBMkIsQ0FBQyxDQUFDO0FBRXJGLE9BQU8sQ0FBQyxPQUFPLEdBQUcsS0FBSyxFQUFFLEtBQVUsRUFBRSxPQUFZLEVBQUUsUUFBYSxFQUFFLEVBQUU7SUFDbEUsUUFBUSxLQUFLLENBQUMsSUFBSSxFQUFFO1FBQ2xCLEtBQUssQ0FBQyxVQUFVLENBQUM7WUFDZixJQUFJLFdBQVcsR0FBRyxJQUFBLDJCQUFpQixFQUFDLEVBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxVQUFVLENBQUMsRUFBQyxDQUFDLENBQUE7WUFDeEYsUUFBUSxDQUFDLElBQUksRUFBRSxNQUFNLE9BQU8sQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQTtZQUNuRCxNQUFNO1FBQ1IsS0FBSyxDQUFDLFlBQVksQ0FBQztZQUNqQixRQUFRLENBQUMsSUFBSSxFQUFFLE1BQU0sU0FBUyxFQUFFLENBQUMsQ0FBQztZQUNsQyxNQUFNO1FBQ1IsS0FBSSxDQUFDLGFBQWEsQ0FBQztZQUNqQixJQUFJLGNBQWMsR0FBRyxJQUFBLDJCQUFpQixFQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDL0QsUUFBUSxDQUFDLElBQUksRUFBRSxNQUFNLFVBQVUsQ0FBQyxjQUFj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RUFBRSx3QkFBd0IsRUFBQyxDQUFDLENBQUM7S0FDeEU7QUFDSCxDQUFDO0FBcEJELGdDQW9CQztBQUVELFNBQWdCLFlBQVksQ0FBQyxJQUFtQjtJQUM5QyxPQUFPO1FBQ0wsVUFBVSxFQUFFLElBQUksQ0FBQyxVQUFVO1FBQzNCLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtRQUNmLE9BQU8sRUFBRTtZQUNQLDZCQUE2QixFQUFFLEdBQUc7U0FDbkM7S0FDRixDQUFBO0FBQ0gsQ0FBQztBQVJELG9DQVFDIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgQVdTID0gcmVxdWlyZSgnYXdzLXNkaycpO1xyXG5jb25zdCBkb2NDbGllbnQgPSBuZXcgQVdTLkR5bmFtb0RCLkRvY3VtZW50Q2xpZW50KCk7XHJcbmNvbnN0IHRhYmxlID0gcHJvY2Vzcy5lbnYuRFlOQU1PX0RCX1RBQkxFO1xyXG5pbXBvcnQgeyBFcnJvciB9IGZyb20gXCJhd3Mtc2RrL2NsaWVudHMvc2VzXCI7XHJcbmltcG9ydCB7IEdhbWUsIFNlcmlhbGl6ZUdhbWVEYXRhLCBJSHR0cFJlc3BvbnNlLCBJR2FtZU9iamVjdCB9IGZyb20gXCIuL01vZHVsZXNcIjtcclxuY29uc3QgYWxsb3dlZFJlcXVlc3RQYXJhbWV0ZXJzID0gSlNPTi5wYXJzZShwcm9jZXNzLmVudi5BTExPV0VEX1JFUVVFU1RfUEFSQU1FVEVSUyEpO1xyXG5cclxuZXhwb3J0cy5oYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBhbnksIGNvbnRleHQ6IGFueSwgY2FsbGJhY2s6IGFueSkgPT4ge1xyXG4gIHN3aXRjaCAoZXZlbnQucGF0aCkge1xyXG4gICAgY2FzZSAoXCIvZ2V0R2FtZVwiKTpcclxuICAgICAgbGV0IGdldEdhbWVEYXRhID0gU2VyaWFsaXplR2FtZURhdGEoe2dhbWVOYW1lOiBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnNbXCJnYW1lTmFtZVwiXX0pXHJcbiAgICAgIGNhbGxiYWNrKG51bGwsIGF3YWl0IGdldEdhbWUoZ2V0R2FtZURhdGEuZ2FtZU5hbWUpKVxyXG4gICAgICBicmVhaztcclxuICAgIGNhc2UgKFwiL2xpc3RHYW1lc1wiKTpcclxuICAgICAgY2FsbGJhY2sobnVsbCwgYXdhaXQgbGlzdEdhbWVzKCkpO1xyXG4gICAgICBicmVhaztcclxuICAgIGNhc2UoXCIvY3JlYXRlR2FtZVwiKTpcclxuICAgICAgbGV0IGNyZWF0ZUdhbWVEYXRhID0gU2VyaWFsaXplR2FtZURhdGEoSlNPTi5wYXJzZShldmVudC5ib2R5KSk7XHJcbiAgICAgIGNhbGxiYWNrKG51bGwsIGF3YWl0IGNyZWF0ZUdhbWUoY3JlYXRlR2FtZURhdGEpKTtcclxuICAgICAgYnJlYWs7XHJcbiAgICBjYXNlKFwiL21vZGlmeUdhbWVcIik6XHJcbiAgICAgIGxldCBtb2RpZnlHYW1lRGF0YSA9IFNlcmlhbGl6ZUdhbWVEYXRhKEpTT04ucGFyc2UoZXZlbnQuYm9keSkpO1xyXG4gICAgICBjYWxsYmFjayhudWxsLCBhd2FpdCBtb2RpZnlHYW1lKG1vZGlmeUdhbWVEYXRhKSk7XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgY2FzZSAoXCIvZGVsZXRlR2FtZVwiKTpcclxuICAgICAgbGV0IGRlbGV0ZUdhbWVEYXRhID0gU2VyaWFsaXplR2FtZURhdGEoSlNPTi5wYXJzZShldmVudC5ib2R5KSk7XHJcbiAgICAgIGNhbGxiYWNrKG51bGwsIGF3YWl0IGRlbGV0ZUdhbWUoZGVsZXRlR2FtZURhdGEuZ2FtZU5hbWUpKTtcclxuICAgICAgYnJlYWs7XHJcbiAgICBkZWZhdWx0OlxyXG4gICAgICBjYWxsYmFjayhudWxsLCBIdHRwUmVzcG9uc2Uoe3N0YXR1c0NvZGU6IDQwMCwgYm9keTogSlNPTi5zdHJpbmdpZnkoXCJJbnZhbGlkIG9wZXJhdGlvbi5cIil9KSk7XHJcbiAgICAgIGJyZWFrO1xyXG4gIH1cclxufSAgXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRHYW1lKGdhbWVOYW1lOiBzdHJpbmcpIHtcclxuICBsZXQgcGFyYW1zID0ge1xyXG4gICAgVGFibGVOYW1lOiB0YWJsZSxcclxuICAgIEtleToge1xyXG4gICAgICBnYW1lTmFtZTogZ2FtZU5hbWVcclxuICAgIH1cclxuICB9O1xyXG5cclxuICB0cnkge1xyXG4gICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LmdldChwYXJhbXMpLnByb21pc2UoKTtcclxuICAgIGlmIChyZXNwb25zZS5JdGVtKSB7XHJcbiAgICAgIGxldCBnYW1lID0gU2VyaWFsaXplR2FtZURhdGEocmVzcG9uc2UuSXRlbSk7XHJcbiAgICAgIHJldHVybiBIdHRwUmVzcG9uc2Uoe3N0YXR1c0NvZGU6IDIwMCwgYm9keTogSlNPTi5zdHJpbmdpZnkoZ2FtZSl9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBIdHRwUmVzcG9uc2Uoe3N0YXR1c0NvZGU6IDQwNCwgYm9keTogXCJVbmFibGUgdG8gZmluZCBnYW1lLlwifSk7XHJcbiAgICB9XHJcbiAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICByZXR1cm4gSHR0cFJlc3BvbnNlKHtzdGF0dXNDb2RlOiA0MDAsIGJvZHk6IFwiVW5hYmxlIHRvIGZpbmQgZ2FtZS5cIn0pO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxpc3RHYW1lcygpIHtcclxuICBsZXQgcGFyYW1zID0ge1xyXG4gICAgVGFibGVOYW1lOiB0YWJsZSxcclxuICAgIFNlbGVjdDogXCJBTExfQVRUUklCVVRFU1wiXHJcbiAgfTtcclxuICBcclxuICB0cnkge1xyXG4gICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNjYW4ocGFyYW1zKS5wcm9taXNlKCk7XHJcbiAgICBsZXQgZ2FtZUxpc3QgOiBHYW1lW10gPSBbXTtcclxuICAgIFxyXG4gICAgaWYgKHJlc3BvbnNlLkl0ZW1zKSB7XHJcbiAgICAgIHJlc3BvbnNlLkl0ZW1zLmZvckVhY2goKGdhbWU6IElHYW1lT2JqZWN0KSA9PiB7XHJcbiAgICAgICAgZ2FtZUxpc3QucHVzaChTZXJpYWxpemVHYW1lRGF0YShnYW1lKSk7XHJcbiAgICAgIH0pO1xyXG4gICAgICByZXR1cm4gSHR0cFJlc3BvbnNlKHtzdGF0dXNDb2RlOiAyMDAsIGJvZHk6IEpTT04uc3RyaW5naWZ5KGdhbWVMaXN0KX0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIEh0dHBSZXNwb25zZSh7c3RhdHVzQ29kZTogNDA0LCBib2R5OiAnR2FtZSBsaXN0IGNvdWxkIG5vdCBiZSBmb3VuZC4nfSlcclxuICAgIH1cclxuICB9IGNhdGNoIChlcnIpIHtcclxuICAgIHJldHVybiBIdHRwUmVzcG9uc2Uoe3N0YXR1c0NvZGU6IDQwMCwgYm9keTogJ0dhbWUgbGlzdCBjb3VsZCBub3QgYmUgZm91bmQuJ30pXHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlR2FtZShnYW1lOiBHYW1lKSB7XHJcbiAgbGV0IHBhcmFtcyA9IHtcclxuICAgIFRhYmxlTmFtZTogdGFibGUsXHJcbiAgICBJdGVtOiB7XHJcbiAgICAgIGdhbWVOYW1lOiBnYW1lLmdhbWVOYW1lLFxyXG4gICAgICBnZW5yZTogZ2FtZS5nZW5yZSxcclxuICAgICAgeWVhclJlbGVhc2VkOiBnYW1lLnllYXJSZWxlYXNlZCxcclxuICAgICAgZGV2ZWxvcGVyOiBnYW1lLmRldmVsb3BlcixcclxuICAgICAgY29uc29sZTogZ2FtZS5jb25zb2xlXHJcbiAgICB9LFxyXG4gICAgQ29uZGl0aW9uRXhwcmVzc2lvbjogJ2F0dHJpYnV0ZV9ub3RfZXhpc3RzKGdhbWVOYW1lKSdcclxuICB9XHJcblxyXG4gIHRyeSB7XHJcbiAgICBsZXQgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQucHV0KHBhcmFtcykucHJvbWlzZSgpO1xyXG4gICAgaWYgKE9iamVjdC5rZXlzKHJlc3BvbnNlKS5sZW5ndGggPT0gMCkge1xyXG4gICAgICByZXR1cm4gSHR0cFJlc3BvbnNlKHtzdGF0dXNDb2RlOiAyMDEsIGJvZHk6IEpTT04uc3RyaW5naWZ5KGdhbWUpfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gSHR0cFJlc3BvbnNlKHtzdGF0dXNDb2RlOiA0MDMsIGJvZHk6ICdVbmFibGUgdG8gY3JlYXRlIGdhbWUuJ30pO1xyXG4gICAgfVxyXG4gIH0gY2F0Y2goZXJyKSB7XHJcbiAgICByZXR1cm4gSHR0cFJlc3BvbnNlKHtzdGF0dXNDb2RlOiA0MDAsIGJvZHk6ICdVbmFibGUgdG8gY3JlYXRlIGdhbWUuJ30pO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG1vZGlmeUdhbWUoZ2FtZTogR2FtZSkge1xyXG4gIGxldCB1cGRhdGVFeHByZXNzaW9uOiBTdHJpbmdbXSA9IFtdO1xyXG4gIGxldCBleHByZXNzaW9uQXR0cmlidXRlTmFtZXMgPSB7fSBhcyBhbnk7XHJcbiAgbGV0IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMgPSB7fSBhcyBhbnk7XHJcbiAgXHJcbiAgLy9HZW5lcmF0ZSBkeW5hbW1pYyB1cGRhdGUgZXhwcmVzc2lvbiBiYXNlZCBvbiBhbGxvd2VkIHBhcmFtZXRlcnNcclxuICBmb3IgKGxldCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoZ2FtZSkpIHtcclxuICAgIGlmIChhbGxvd2VkUmVxdWVzdFBhcmFtZXRlcnMuaW5jbHVkZXMoa2V5KSAmJiB2YWx1ZSAhPSB1bmRlZmluZWQpIHtcclxuICAgICAgdXBkYXRlRXhwcmVzc2lvbi5wdXNoKGAjJHtrZXl9ID0gOiR7a2V5fWApO1xyXG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlTmFtZXNbJyMnK2tleV0gPSBrZXkgO1xyXG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6JytrZXldPWAke3ZhbHVlfWA7ICBcclxuICAgIH1cclxuICB9XHJcbiAgXHJcbiAgbGV0IHBhcmFtcyA9IHtcclxuICAgIFRhYmxlTmFtZTogdGFibGUsXHJcbiAgICBLZXk6IHtcclxuICAgICAgZ2FtZU5hbWU6IGdhbWUuZ2FtZU5hbWVcclxuICAgIH0sXHJcbiAgICBVcGRhdGVFeHByZXNzaW9uOiBgU0VUICR7dXBkYXRlRXhwcmVzc2lvbi5qb2luKFwiLFwiKX1gLFxyXG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiBleHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXHJcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxyXG4gICAgQ29uZGl0aW9uRXhwcmVzc2lvbjogJ2F0dHJpYnV0ZV9leGlzdHMoZ2FtZU5hbWUpJyxcclxuICAgIFJldHVyblZhbHVlczogJ0FMTF9ORVcnXHJcbiAgfTtcclxuXHJcbiAgdHJ5IHtcclxuICAgIGxldCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC51cGRhdGUocGFyYW1zKS5wcm9taXNlKCk7XHJcbiAgICBpZiAocmVzcG9uc2UuQXR0cmlidXRlcykge1xyXG4gICAgICBsZXQgbW9kaWZpZWRHYW1lID0gU2VyaWFsaXplR2FtZURhdGEocmVzcG9uc2UuQXR0cmlidXRlcyk7XHJcbiAgICAgIHJldHVybiBIdHRwUmVzcG9uc2Uoe3N0YXR1c0NvZGU6IDIwMCwgYm9keTogSlNPTi5zdHJpbmdpZnkobW9kaWZpZWRHYW1lKX0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIEh0dHBSZXNwb25zZSh7c3RhdHVzQ29kZTogNDAzLCBib2R5OiAnVW5hYmxlIHRvIG1vZGlmeSBnYW1lLid9KTtcclxuICAgIH1cclxuICB9IGNhdGNoIChlcnIpIHtcclxuICAgIHJldHVybiBIdHRwUmVzcG9uc2Uoe3N0YXR1c0NvZGU6IDQwMCwgYm9keTogJ1VuYWJsZSB0byBtb2RpZnkgZ2FtZS4nfSk7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVsZXRlR2FtZShnYW1lTmFtZTogc3RyaW5nKSB7XHJcbiAgbGV0IHBhcmFtcyA9IHtcclxuICAgIFRhYmxlTmFtZTogdGFibGUsXHJcbiAgICBLZXk6IHtcclxuICAgICAgICBnYW1lTmFtZTogZ2FtZU5hbWVcclxuICAgIH0sXHJcbiAgICBSZXR1cm5WYWx1ZXM6ICdBTExfT0xEJ1xyXG4gIH07XHJcbiAgXHJcbiAgdHJ5IHtcclxuICAgIGxldCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5kZWxldGUocGFyYW1zKS5wcm9taXNlKCk7XHJcbiAgICBpZiAocmVzcG9uc2UuQXR0cmlidXRlcykge1xyXG4gICAgICBsZXQgZGVsZXRlZEdhbWUgPSBTZXJpYWxpemVHYW1lRGF0YShyZXNwb25zZS5BdHRyaWJ1dGVzKTtcclxuICAgICAgcmV0dXJuIEh0dHBSZXNwb25zZSh7c3RhdHVzQ29kZTogMjAwLCBib2R5OiBKU09OLnN0cmluZ2lmeShkZWxldGVkR2FtZSl9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBIdHRwUmVzcG9uc2Uoe3N0YXR1c0NvZGU6IDQwNCwgYm9keTogJ1VuYWJsZSB0byBkZWxldGUgZ2FtZS4nfSk7XHJcbiAgICB9XHJcbiAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICByZXR1cm4gSHR0cFJlc3BvbnNlKHtzdGF0dXNDb2RlOiA0MDAsIGJvZHk6ICdVbmFibGUgdG8gZGVsZXRlIGdhbWUuJ30pO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIEh0dHBSZXNwb25zZShkYXRhOiBJSHR0cFJlc3BvbnNlKSB7XHJcbiAgcmV0dXJuIHtcclxuICAgIHN0YXR1c0NvZGU6IGRhdGEuc3RhdHVzQ29kZSxcclxuICAgIGJvZHk6IGRhdGEuYm9keSxcclxuICAgIGhlYWRlcnM6IHtcclxuICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJ1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=