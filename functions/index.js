"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const AWS = require('aws-sdk');
const docClient = new AWS.DynamoDB.DocumentClient();
const table = process.env.DYNAMO_DB_TABLE;
const Modules_1 = require("./Modules");
const allowedRequestParameters = JSON.parse(process.env.ALLOWED_REQUEST_PARAMETERS);
exports.handler = async (event, context, callback) => {
    switch (event.path) {
        case ("/getGame"):
            await getGame(event.queryStringParameters["gameName"]);
            break;
        case ("/listGames"):
            await listGames();
            break;
        case ("/createGame"):
            await createGame(new Modules_1.Game(JSON.parse(event.body).gameName, JSON.parse(event.body).yearReleased, JSON.parse(event.body).genre, JSON.parse(event.body).console, JSON.parse(event.body).developer));
            break;
        case ("/modifyGame"):
            await modifyGame(new Modules_1.Game(JSON.parse(event.body).gameName, JSON.parse(event.body).yearReleased, JSON.parse(event.body).genre, JSON.parse(event.body).console, JSON.parse(event.body).developer));
            break;
        case ("/deleteGame"):
            await deleteGame(JSON.parse(event.body).gameName);
            break;
        default:
            HttpResponse({ statusCode: 400, body: JSON.stringify("Unable to process request") });
            break;
    }
    async function getGame(gameName) {
        let params = {
            TableName: table,
            Key: {
                gameName: gameName
            }
        };
        try {
            let response = await docClient.get(params).promise();
            if (response.Item) {
                let game = new Modules_1.Game(response.Item.gameName, response.Item.yearReleased, response.Item.genre, response.Item.console, response.Item.developer);
                HttpResponse({ statusCode: 200, body: JSON.stringify(game) });
            }
            else {
                throw Error;
            }
        }
        catch (err) {
            throw HttpResponse({ statusCode: 404, body: `Unable to find game.` });
        }
    }
    async function listGames() {
        let params = {
            TableName: table,
            Select: "ALL_ATTRIBUTES"
        };
        try {
            let response = await docClient.scan(params).promise();
            let gameList = [];
            if (response.Items) {
                response.Items.forEach((game) => {
                    gameList.push(new Modules_1.Game(game.gameName, game.yearReleased, game.genre, game.console, game.developer));
                });
                HttpResponse({ statusCode: 200, body: JSON.stringify(gameList) });
            }
            else {
                throw Error;
            }
        }
        catch (err) {
            throw HttpResponse({ statusCode: 404, body: `Game list could not be found.` });
        }
    }
    async function createGame(game) {
        let params = {
            TableName: table,
            Item: {
                gameName: game.gameName,
                genre: game.genre,
                yearReleased: game.yearReleased,
                developer: game.developer,
                console: game.console
            },
            ConditionExpression: 'attribute_not_exists(gameName)'
        };
        try {
            let response = await docClient.put(params).promise();
            if (Object.keys(response).length == 0) {
                HttpResponse({ statusCode: 201, body: JSON.stringify(game) });
            }
            else {
                throw Error;
            }
        }
        catch (err) {
            throw HttpResponse({ statusCode: 403, body: `Unable to create game.` });
        }
    }
    async function modifyGame(game) {
        let updateExpression = [];
        let expressionAttributeNames = {};
        let expressionAttributeValues = {};
        let body = JSON.parse(event.body);
        //Generate dynammic update expression based on allowed parameters
        for (let parameter in body) {
            if (allowedRequestParameters.includes(parameter)) {
                updateExpression.push(`#${parameter} = :${parameter}`);
                expressionAttributeNames['#' + parameter] = parameter;
                expressionAttributeValues[':' + parameter] = `${body[parameter]}`;
            }
        }
        let params = {
            TableName: table,
            Key: {
                gameName: body.gameName
            },
            UpdateExpression: `SET ${updateExpression.join(",")}`,
            ExpressionAttributeNames: expressionAttributeNames,
            ExpressionAttributeValues: expressionAttributeValues,
            ConditionExpression: 'attribute_exists(gameName)',
            ReturnValues: 'ALL_NEW'
        };
        try {
            let response = await docClient.update(params).promise();
            if (response.Attributes) {
                HttpResponse({ statusCode: 200, body: JSON.stringify(game) });
            }
            else {
                throw Error;
            }
        }
        catch (err) {
            throw HttpResponse({ statusCode: 403, body: `Unable to modify game.` });
        }
    }
    async function deleteGame(gameName) {
        let params = {
            TableName: table,
            Key: {
                gameName: gameName
            },
            ReturnValues: 'ALL_OLD'
        };
        try {
            let response = await docClient.delete(params).promise();
            if (response.Attributes) {
                let game = new Modules_1.Game(response.Attributes.gameName, response.Attributes.yearReleased, response.Attributes.genre, response.Attributes.console, response.Attributes.developer);
                HttpResponse({ statusCode: 200, body: JSON.stringify(game) });
            }
            else {
                throw Error;
            }
        }
        catch (err) {
            throw HttpResponse({ statusCode: 400, body: `Unable to delete game.` });
        }
    }
    function HttpResponse(data) {
        callback(null, {
            statusCode: data.statusCode,
            body: data.body,
            headers: {
                'Access-Control-Allow-Origin': '*'
            }
        });
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUMvQixNQUFNLFNBQVMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsY0FBYyxFQUFFLENBQUM7QUFDcEQsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUM7QUFDMUMsdUNBQXlFO0FBQ3pFLE1BQU0sd0JBQXdCLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLDBCQUEyQixDQUFDLENBQUM7QUFFckYsT0FBTyxDQUFDLE9BQU8sR0FBRyxLQUFLLEVBQUUsS0FBVSxFQUFFLE9BQVksRUFBRSxRQUFhLEVBQUUsRUFBRTtJQUNsRSxRQUFRLEtBQUssQ0FBQyxJQUFJLEVBQUU7UUFDbEIsS0FBSyxDQUFDLFVBQVUsQ0FBQztZQUNmLE1BQU0sT0FBTyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1lBQ3ZELE1BQU07UUFDUixLQUFLLENBQUMsWUFBWSxDQUFDO1lBQ2pCLE1BQU0sU0FBUyxFQUFFLENBQUM7WUFDbEIsTUFBTTtRQUNSLEtBQUksQ0FBQyxhQUFhLENBQUM7WUFDakIsTUFBTSxVQUFVLENBQUMsSUFBSSxjQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxL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O1lBQ1osTUFBTSxZQUFZLENBQUMsRUFBQyxVQUFVLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSx3QkFBd0IsRUFBQyxDQUFDLENBQUM7U0FDdkU7SUFDSCxDQUFDO0lBRUQsU0FBUyxZQUFZLENBQUMsSUFBbUI7UUFDdkMsUUFBUSxDQUFDLElBQUksRUFBRTtZQUNiLFVBQVUsRUFBRSxJQUFJLENBQUMsVUFBVTtZQUMzQixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7WUFDZixPQUFPLEVBQUU7Z0JBQ1AsNkJBQTZCLEVBQUUsR0FBRzthQUNuQztTQUNGLENBQUMsQ0FBQTtJQUNKLENBQUM7QUFDSCxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBBV1MgPSByZXF1aXJlKCdhd3Mtc2RrJyk7XHJcbmNvbnN0IGRvY0NsaWVudCA9IG5ldyBBV1MuRHluYW1vREIuRG9jdW1lbnRDbGllbnQoKTtcclxuY29uc3QgdGFibGUgPSBwcm9jZXNzLmVudi5EWU5BTU9fREJfVEFCTEU7XHJcbmltcG9ydCB7IEdhbWUgYXMgR2FtZSwgSUh0dHBSZXNwb25zZSBhcyBJSHR0cFJlc3BvbnNlIH0gZnJvbSBcIi4vTW9kdWxlc1wiO1xyXG5jb25zdCBhbGxvd2VkUmVxdWVzdFBhcmFtZXRlcnMgPSBKU09OLnBhcnNlKHByb2Nlc3MuZW52LkFMTE9XRURfUkVRVUVTVF9QQVJBTUVURVJTISk7XHJcblxyXG5leHBvcnRzLmhhbmRsZXIgPSBhc3luYyAoZXZlbnQ6IGFueSwgY29udGV4dDogYW55LCBjYWxsYmFjazogYW55KSA9PiB7XHJcbiAgc3dpdGNoIChldmVudC5wYXRoKSB7XHJcbiAgICBjYXNlIChcIi9nZXRHYW1lXCIpOlxyXG4gICAgICBhd2FpdCBnZXRHYW1lKGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVyc1tcImdhbWVOYW1lXCJdKTtcclxuICAgICAgYnJlYWs7XHJcbiAgICBjYXNlIChcIi9saXN0R2FtZXNcIik6XHJcbiAgICAgIGF3YWl0IGxpc3RHYW1lcygpO1xyXG4gICAgICBicmVhaztcclxuICAgIGNhc2UoXCIvY3JlYXRlR2FtZVwiKTpcclxuICAgICAgYXdhaXQgY3JlYXRlR2FtZShuZXcgR2FtZShKU09OLnBhcnNlKGV2ZW50LmJvZHkpLmdhbWVOYW1lLCBKU09OLnBhcnNlKGV2ZW50LmJvZHkpLnllYXJSZWxlYXNlZCwgSlNPTi5wYXJzZShldmVudC5ib2R5KS5nZW5yZSwgSlNPTi5wYXJzZShldmVudC5ib2R5KS5jb25zb2xlLCBKU09OLnBhcnNlKGV2ZW50LmJvZHkpLmRldmVsb3BlcikpO1xyXG4gICAgICBicmVhaztcclxuICAgIGNhc2UoXCIvbW9kaWZ5R2FtZVwiKTpcclxuICAgICAgYXdhaXQgbW9kaWZ5R2FtZShuZXcgR2FtZShKU09OLnBhcnNlKGV2ZW50LmJvZHkpLmdhbWVOYW1lLCBKU09OLnBhcnNlKGV2ZW50LmJvZHkpLnllYXJSZWxlYXNlZCwgSlNPTi5wYXJzZShldmVudC5ib2R5KS5nZW5yZSwgSlNPTi5wYXJzZShldmVudC5ib2R5KS5jb25zb2xlLCBKU09OLnBhcnNlKGV2ZW50LmJvZHkpLmRldmVsb3BlcikpO1xyXG4gICAgICBicmVhaztcclxuICAgIGNhc2UgKFwiL2RlbGV0ZUdhbWVcIik6XHJcbiAgICAgIGF3YWl0IGRlbGV0ZUdhbWUoSlNPTi5wYXJzZShldmVudC5ib2R5KS5nYW1lTmFtZSk7XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgZGVmYXVsdDpcclxuICAgICAgSHR0cFJlc3BvbnNlKHtzdGF0dXNDb2RlOiA0MDAsIGJvZHk6IEpTT04uc3RyaW5naWZ5KFwiVW5hYmxlIHRvIHByb2Nlc3MgcmVxdWVzdFwiKX0pO1xyXG4gICAgICBicmVhaztcclxuICB9XHJcbiAgXHJcbiAgYXN5bmMgZnVuY3Rpb24gZ2V0R2FtZShnYW1lTmFtZTogc3RyaW5nKSB7XHJcbiAgICBsZXQgcGFyYW1zID0ge1xyXG4gICAgICBUYWJsZU5hbWU6IHRhYmxlLFxyXG4gICAgICBLZXk6IHtcclxuICAgICAgICBnYW1lTmFtZTogZ2FtZU5hbWVcclxuICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICBsZXQgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQuZ2V0KHBhcmFtcykucHJvbWlzZSgpO1xyXG4gICAgICBpZiAocmVzcG9uc2UuSXRlbSkge1xyXG4gICAgICAgIGxldCBnYW1lID0gbmV3IEdhbWUocmVzcG9uc2UuSXRlbS5nYW1lTmFtZSwgcmVzcG9uc2UuSXRlbS55ZWFyUmVsZWFzZWQsIHJlc3BvbnNlLkl0ZW0uZ2VucmUsIHJlc3BvbnNlLkl0ZW0uY29uc29sZSwgcmVzcG9uc2UuSXRlbS5kZXZlbG9wZXIpO1xyXG4gICAgICAgIEh0dHBSZXNwb25zZSh7c3RhdHVzQ29kZTogMjAwLCBib2R5OiBKU09OLnN0cmluZ2lmeShnYW1lKX0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRocm93IEVycm9yO1xyXG4gICAgIH1cclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICB0aHJvdyBIdHRwUmVzcG9uc2Uoe3N0YXR1c0NvZGU6IDQwNCwgYm9keTogYFVuYWJsZSB0byBmaW5kIGdhbWUuYH0pO1xyXG4gICAgfVxyXG4gIH1cclxuICBcclxuICBhc3luYyBmdW5jdGlvbiBsaXN0R2FtZXMoKSB7XHJcbiAgICBsZXQgcGFyYW1zID0ge1xyXG4gICAgICBUYWJsZU5hbWU6IHRhYmxlLFxyXG4gICAgICBTZWxlY3Q6IFwiQUxMX0FUVFJJQlVURVNcIlxyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdHJ5IHtcclxuICAgICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNjYW4ocGFyYW1zKS5wcm9taXNlKCk7XHJcbiAgICAgIGxldCBnYW1lTGlzdCA6IEdhbWVbXSA9IFtdO1xyXG4gICAgICBcclxuICAgICAgaWYgKHJlc3BvbnNlLkl0ZW1zKSB7XHJcbiAgICAgICAgcmVzcG9uc2UuSXRlbXMuZm9yRWFjaCgoZ2FtZTogR2FtZSkgPT4ge1xyXG4gICAgICAgICAgZ2FtZUxpc3QucHVzaChuZXcgR2FtZShnYW1lLmdhbWVOYW1lLCBnYW1lLnllYXJSZWxlYXNlZCwgZ2FtZS5nZW5yZSwgZ2FtZS5jb25zb2xlLCBnYW1lLmRldmVsb3BlcikpO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgSHR0cFJlc3BvbnNlKHtzdGF0dXNDb2RlOiAyMDAsIGJvZHk6IEpTT04uc3RyaW5naWZ5KGdhbWVMaXN0KX0pXHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhyb3cgRXJyb3I7XHJcbiAgICAgfVxyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgIHRocm93IEh0dHBSZXNwb25zZSh7c3RhdHVzQ29kZTogNDA0LCBib2R5OiBgR2FtZSBsaXN0IGNvdWxkIG5vdCBiZSBmb3VuZC5gfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBmdW5jdGlvbiBjcmVhdGVHYW1lKGdhbWU6IEdhbWUpIHtcclxuICAgIGxldCBwYXJhbXMgPSB7XHJcbiAgICAgIFRhYmxlTmFtZTogdGFibGUsXHJcbiAgICAgIEl0ZW06IHtcclxuICAgICAgICBnYW1lTmFtZTogZ2FtZS5nYW1lTmFtZSxcclxuICAgICAgICBnZW5yZTogZ2FtZS5nZW5yZSxcclxuICAgICAgICB5ZWFyUmVsZWFzZWQ6IGdhbWUueWVhclJlbGVhc2VkLFxyXG4gICAgICAgIGRldmVsb3BlcjogZ2FtZS5kZXZlbG9wZXIsXHJcbiAgICAgICAgY29uc29sZTogZ2FtZS5jb25zb2xlXHJcbiAgICAgIH0sXHJcbiAgICAgIENvbmRpdGlvbkV4cHJlc3Npb246ICdhdHRyaWJ1dGVfbm90X2V4aXN0cyhnYW1lTmFtZSknXHJcbiAgICB9XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnB1dChwYXJhbXMpLnByb21pc2UoKTtcclxuICAgICAgaWYgKE9iamVjdC5rZXlzKHJlc3BvbnNlKS5sZW5ndGggPT0gMCkge1xyXG4gICAgICAgIEh0dHBSZXNwb25zZSh7c3RhdHVzQ29kZTogMjAxLCBib2R5OiBKU09OLnN0cmluZ2lmeShnYW1lKX0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRocm93IEVycm9yO1xyXG4gICAgIH1cclxuICAgIH0gY2F0Y2goZXJyKSB7XHJcbiAgICAgIHRocm93IEh0dHBSZXNwb25zZSh7c3RhdHVzQ29kZTogNDAzLCBib2R5OiBgVW5hYmxlIHRvIGNyZWF0ZSBnYW1lLmB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGZ1bmN0aW9uIG1vZGlmeUdhbWUoZ2FtZTogR2FtZSkge1xyXG4gICAgbGV0IHVwZGF0ZUV4cHJlc3Npb246IFN0cmluZ1tdID0gW107XHJcbiAgICBsZXQgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzID0ge30gYXMgYW55O1xyXG4gICAgbGV0IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMgPSB7fSBhcyBhbnk7XHJcbiAgICBsZXQgYm9keSA9IEpTT04ucGFyc2UoZXZlbnQuYm9keSk7XHJcbiAgICBcclxuICAgIC8vR2VuZXJhdGUgZHluYW1taWMgdXBkYXRlIGV4cHJlc3Npb24gYmFzZWQgb24gYWxsb3dlZCBwYXJhbWV0ZXJzXHJcbiAgICBmb3IgKGxldCBwYXJhbWV0ZXIgaW4gYm9keSkge1xyXG4gICAgICBpZiAoYWxsb3dlZFJlcXVlc3RQYXJhbWV0ZXJzLmluY2x1ZGVzKHBhcmFtZXRlcikpIHtcclxuICAgICAgICB1cGRhdGVFeHByZXNzaW9uLnB1c2goYCMke3BhcmFtZXRlcn0gPSA6JHtwYXJhbWV0ZXJ9YCk7XHJcbiAgICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzWycjJytwYXJhbWV0ZXJdID0gcGFyYW1ldGVyIDtcclxuICAgICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6JytwYXJhbWV0ZXJdPWAke2JvZHlbcGFyYW1ldGVyXX1gOyAgXHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIFxyXG4gICAgbGV0IHBhcmFtcyA9IHtcclxuICAgICAgVGFibGVOYW1lOiB0YWJsZSxcclxuICAgICAgS2V5OiB7XHJcbiAgICAgICAgZ2FtZU5hbWU6IGJvZHkuZ2FtZU5hbWVcclxuICAgICAgfSxcclxuICAgICAgVXBkYXRlRXhwcmVzc2lvbjogYFNFVCAke3VwZGF0ZUV4cHJlc3Npb24uam9pbihcIixcIil9YCxcclxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiBleHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXHJcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMsXHJcbiAgICAgIENvbmRpdGlvbkV4cHJlc3Npb246ICdhdHRyaWJ1dGVfZXhpc3RzKGdhbWVOYW1lKScsXHJcbiAgICAgIFJldHVyblZhbHVlczogJ0FMTF9ORVcnXHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB0cnkge1xyXG4gICAgICBsZXQgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQudXBkYXRlKHBhcmFtcykucHJvbWlzZSgpO1xyXG4gICAgICBpZiAocmVzcG9uc2UuQXR0cmlidXRlcykge1xyXG4gICAgICAgIEh0dHBSZXNwb25zZSh7c3RhdHVzQ29kZTogMjAwLCBib2R5OiBKU09OLnN0cmluZ2lmeShnYW1lKX0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRocm93IEVycm9yO1xyXG4gICAgICB9XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgdGhyb3cgSHR0cFJlc3BvbnNlKHtzdGF0dXNDb2RlOiA0MDMsIGJvZHk6IGBVbmFibGUgdG8gbW9kaWZ5IGdhbWUuYH0pO1xyXG4gICAgfVxyXG4gIH1cclxuICBcclxuICBhc3luYyBmdW5jdGlvbiBkZWxldGVHYW1lKGdhbWVOYW1lOiBzdHJpbmcpIHtcclxuICAgIGxldCBwYXJhbXMgPSB7XHJcbiAgICAgIFRhYmxlTmFtZTogdGFibGUsXHJcbiAgICAgIEtleToge1xyXG4gICAgICAgICAgZ2FtZU5hbWU6IGdhbWVOYW1lXHJcbiAgICAgIH0sXHJcbiAgICAgIFJldHVyblZhbHVlczogJ0FMTF9PTEQnXHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB0cnkge1xyXG4gICAgICBsZXQgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQuZGVsZXRlKHBhcmFtcykucHJvbWlzZSgpO1xyXG4gICAgICBpZiAocmVzcG9uc2UuQXR0cmlidXRlcykge1xyXG4gICAgICAgIGxldCBnYW1lID0gbmV3IEdhbWUocmVzcG9uc2UuQXR0cmlidXRlcy5nYW1lTmFtZSwgcmVzcG9uc2UuQXR0cmlidXRlcy55ZWFyUmVsZWFzZWQsIHJlc3BvbnNlLkF0dHJpYnV0ZXMuZ2VucmUsIHJlc3BvbnNlLkF0dHJpYnV0ZXMuY29uc29sZSwgcmVzcG9uc2UuQXR0cmlidXRlcy5kZXZlbG9wZXIpO1xyXG4gICAgICAgIEh0dHBSZXNwb25zZSh7c3RhdHVzQ29kZTogMjAwLCBib2R5OiBKU09OLnN0cmluZ2lmeShnYW1lKX0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRocm93IEVycm9yO1xyXG4gICAgIH1cclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICB0aHJvdyBIdHRwUmVzcG9uc2Uoe3N0YXR1c0NvZGU6IDQwMCwgYm9keTogYFVuYWJsZSB0byBkZWxldGUgZ2FtZS5gfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBIdHRwUmVzcG9uc2UoZGF0YTogSUh0dHBSZXNwb25zZSkge1xyXG4gICAgY2FsbGJhY2sobnVsbCwge1xyXG4gICAgICBzdGF0dXNDb2RlOiBkYXRhLnN0YXR1c0NvZGUsXHJcbiAgICAgIGJvZHk6IGRhdGEuYm9keSxcclxuICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKidcclxuICAgICAgfVxyXG4gICAgfSlcclxuICB9XHJcbn0iXX0=